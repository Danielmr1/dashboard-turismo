<!DOCTYPE html>
<html lang="es" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Administrativo - Turismo</title>

    <!-- LIBRERÍAS EXTERNAS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SheetJS for Excel Export -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <!-- FONTS -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#151f32', 900: '#0f172a', 950: '#020617' },
                        primary: { 500: '#6366f1', 600: '#4f46e5' }
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap"
        rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .sidebar-link {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar-link:hover,
        .sidebar-link.active {
            background: rgba(99, 102, 241, 0.1);
            color: #818cf8;
            border-right: 3px solid #6366f1;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }

        .loading-overlay {
            animation: pulseBg 2s infinite;
        }

        @keyframes pulseBg {
            0% {
                opacity: 0.8;
            }

            50% {
                opacity: 0.4;
            }

            100% {
                opacity: 0.8;
            }
        }
    </style>
</head>

<body class="bg-slate-950 text-slate-200 h-screen flex overflow-hidden selection:bg-indigo-500 selection:text-white">

    <!-- MOBILE OVERLAY -->
    <div id="sidebar-overlay" onclick="toggleSidebar()"
        class="fixed inset-0 bg-slate-950/80 z-40 hidden lg:hidden backdrop-blur-sm transition-opacity opacity-0"></div>

    <!-- SIDEBAR -->
    <aside id="sidebar"
        class="fixed inset-y-0 left-0 z-50 w-64 bg-slate-900 border-r border-slate-800 flex flex-col transform -translate-x-full transition-transform duration-300 lg:translate-x-0 lg:static lg:inset-auto lg:flex shrink-0 shadow-2xl lg:shadow-none">
        <div class="h-16 flex items-center justify-start px-6 border-b border-slate-800 relative">
            <!-- Close Button Mobile -->
            <button onclick="toggleSidebar()" class="absolute right-4 lg:hidden text-slate-400 hover:text-white">
                <i class="fas fa-times"></i>
            </button>
            <div
                class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white font-black text-lg shadow-lg shadow-indigo-500/20">
                <i class="fas fa-mountain"></i>
            </div>
            <span class="ml-3 font-bold text-lg tracking-tight text-white">TURISMO<span
                    class="text-indigo-400">DATA</span></span>
        </div>

        <nav class="flex-1 py-6 space-y-2 px-2">
            <a href="#" onclick="switchView('overview')" id="nav-overview"
                class="sidebar-link active flex items-center gap-4 px-3 py-3 rounded-xl text-slate-400 hover:text-indigo-400 group">
                <i class="fas fa-chart-pie text-xl w-6 text-center group-hover:scale-110 transition"></i>
                <span class="font-medium text-sm">Visión General</span>
            </a>
            <a href="#" onclick="switchView('leads')" id="nav-leads"
                class="sidebar-link flex items-center gap-4 px-3 py-3 rounded-xl text-slate-400 hover:text-indigo-400 group">
                <i class="fas fa-users text-xl w-6 text-center group-hover:scale-110 transition"></i>
                <span class="font-medium text-sm">Base de Contactos</span>
            </a>
            <a href="#" onclick="switchView('form')" id="nav-form"
                class="sidebar-link flex items-center gap-4 px-3 py-3 rounded-xl text-slate-400 hover:text-emerald-400 group">
                <i
                    class="fas fa-plus-circle text-xl w-6 text-center group-hover:scale-110 transition text-emerald-500"></i>
                <span class="font-medium text-sm text-emerald-400">Nuevo Contacto</span>
            </a>
        </nav>

        <div class="p-4 border-t border-slate-800">
            <div id="status-pill"
                class="flex items-center justify-center lg:justify-start gap-2 py-2 px-3 bg-slate-800/50 rounded-lg text-xs font-mono text-emerald-400">
                <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                <span class="uppercase tracking-wider font-bold">Conectado</span>
            </div>
        </div>
    </aside>

    <!-- CONTENT -->
    <main class="flex-1 flex flex-col h-full overflow-hidden relative">
        <!-- HEADER -->
        <header
            class="bg-slate-900/50 backdrop-blur-md border-b border-slate-700/50 p-4 lg:px-8 flex justify-between items-center sticky top-0 z-40">
            <div class="flex items-center gap-4">
                <button id="mobile-menu-btn" onclick="toggleSidebar()"
                    class="lg:hidden text-slate-400 hover:text-white transition">
                    <i class="fas fa-bars text-xl"></i>
                </button>
                <h2 id="page-title" class="text-xl font-bold text-white tracking-tight">Dashboard <span
                        class="text-xs text-indigo-400 font-normal">(v3.3-stable)</span></h2>
            </div>

            <!-- GLOBAL DATE FILTER (Overview Only) -->
            <div id="global-date-filter" class="hidden md:flex bg-slate-800 rounded-lg p-1 border border-slate-700">
                <button onclick="setGlobalFilter('30d')" id="btn-filter-30d"
                    class="px-3 py-1 text-xs font-bold rounded-md transition bg-indigo-600 text-white shadow-lg">
                    Últimos 30 días
                </button>
                <button onclick="setGlobalFilter('general')" id="btn-filter-general"
                    class="px-3 py-1 text-xs font-bold rounded-md transition text-slate-400 hover:text-white hover:bg-slate-700">
                    General
                </button>
            </div>

            <div class="flex items-center gap-4">
                <button onclick="exportDailyReport()"
                    class="hidden md:flex items-center gap-2 px-3 py-1 text-xs font-bold rounded-md bg-emerald-600 hover:bg-emerald-500 text-white transition shadow-lg shadow-emerald-900/20">
                    <i class="fas fa-file-excel"></i>
                    <span>Exportar Hoy</span>
                </button>

                <button onclick="refreshData()"
                    class="text-slate-400 hover:text-white transition transform hover:rotate-180 duration-500"
                    title="Actualizar Datos">
                    <i class="fas fa-sync-alt" id="refresh-icon"></i>
                </button>
            </div>
        </header>

        <!-- SCROLLABLE CONTENT -->
        <div id="content-area" class="flex-1 overflow-y-auto p-4 lg:p-8 scroll-smooth relative">

            <!-- VIEW: OVERVIEW -->
            <div id="view-overview" class="space-y-6 max-w-7xl mx-auto fade-in">
                <!-- KPI CARDS -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="glass-panel p-5 rounded-2xl relative overflow-hidden group">
                        <div
                            class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition transform group-hover:scale-110">
                            <i class="fas fa-wallet text-6xl text-emerald-400"></i>
                        </div>
                        <p class="text-slate-400 text-xs font-bold uppercase tracking-widest mb-1">Ingresos Estimados
                        </p>
                        <h3 class="text-3xl font-black text-white" id="kpi-ingresos">S/ --</h3>
                    </div>

                    <div class="glass-panel p-5 rounded-2xl relative overflow-hidden group">
                        <div
                            class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition transform group-hover:scale-110">
                            <i class="fas fa-calendar-check text-6xl text-indigo-400"></i>
                        </div>
                        <p class="text-slate-400 text-xs font-bold uppercase tracking-widest mb-1">Turistas /
                            Oportunidad</p>
                        <h3 class="text-3xl font-black text-white" id="kpi-leads">-- / --</h3>
                    </div>

                    <div class="glass-panel p-5 rounded-2xl relative overflow-hidden group">
                        <div
                            class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition transform group-hover:scale-110">
                            <i class="fas fa-fire text-6xl text-amber-400"></i>
                        </div>
                        <p class="text-slate-400 text-xs font-bold uppercase tracking-widest mb-1">Paquete Top</p>
                        <h3 class="text-xl font-black text-white truncate" id="kpi-top-package">--</h3>
                    </div>

                    <div class="glass-panel p-5 rounded-2xl relative overflow-hidden group">
                        <div
                            class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition transform group-hover:scale-110">
                            <i class="fas fa-map-marker-alt text-6xl text-rose-400"></i>
                        </div>
                        <p class="text-slate-400 text-xs font-bold uppercase tracking-widest mb-1">Origen Principal</p>
                        <h3 class="text-2xl font-black text-white" id="kpi-top-city">--</h3>
                    </div>
                </div>

                <!-- OPERATIONAL FORECAST CHART (NEW) -->
                <div class="glass-panel p-6 rounded-2xl flex flex-col mb-6 h-80">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-sm text-slate-300 uppercase tracking-wide">Pronóstico Operativo</h3>
                    </div>
                    <div class="flex-1 relative w-full h-full min-h-0">
                        <canvas id="chart-forecast"></canvas>
                    </div>
                </div>

                <!-- CHARTS ROW 1 -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-auto lg:h-96">
                    <!-- MAIN CHART -->
                    <div class="lg:col-span-2 glass-panel p-6 rounded-2xl flex flex-col">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="font-bold text-sm text-slate-300 uppercase tracking-wide">Evolución de Leads</h3>
                        </div>
                        <div class="flex-1 relative w-full h-full min-h-0">
                            <canvas id="chart-timeline"></canvas>
                        </div>
                    </div>

                    <!-- DONUT CHART -->
                    <div class="glass-panel p-6 rounded-2xl flex flex-col">
                        <h3 class="font-bold text-sm text-slate-300 uppercase tracking-wide mb-6">Origen de Turistas
                        </h3>
                        <div class="flex-1 relative flex items-center justify-center">
                            <canvas id="chart-origin"></canvas>
                        </div>
                    </div>
                </div>

                <!-- CHARTS ROW 2 -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 h-auto lg:h-80">
                    <!-- BAR CHART -->
                    <div class="glass-panel p-6 rounded-2xl flex flex-col">
                        <h3 class="font-bold text-sm text-slate-300 uppercase tracking-wide mb-4">Top 5 Paquetes
                            Vendidos</h3>
                        <div class="flex-1 relative w-full h-full min-h-0">
                            <canvas id="chart-packages"></canvas>
                        </div>
                    </div>
                    <!-- TABLE PREVIEW -->
                    <div class="glass-panel p-6 rounded-2xl flex flex-col overflow-hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-sm text-slate-300 uppercase tracking-wide">Últimos Registros</h3>
                            <button onclick="switchView('leads')"
                                class="text-xs text-indigo-400 hover:text-indigo-300 font-bold">Ver Todo</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-xs">
                                <thead class="text-slate-500 font-semibold border-b border-slate-700">
                                    <tr>
                                        <th class="pb-3 pl-2">Nombre</th>
                                        <th class="pb-3 text-center">Tour</th>
                                        <th class="pb-3 text-right">Monto</th>
                                    </tr>
                                </thead>
                                <tbody id="table-preview-body" class="divide-y divide-slate-800 text-slate-300"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW: LEADS TABLE -->
            <div id="view-leads" class="hidden space-y-6 max-w-7xl mx-auto fade-in">
                <!-- TABLE CONTROLS: SEARCH & FILTER -->
                <div
                    class="glass-panel p-4 mb-4 rounded-2xl flex flex-col sm:flex-row gap-4 justify-between items-center">
                    <h3 class="font-bold text-lg hidden sm:block pl-2">Base de Datos</h3>

                    <!-- Search -->
                    <div class="relative w-full sm:w-96">
                        <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-slate-500"></i>
                        <input type="text" id="table-search" oninput="applyFilters()"
                            class="w-full bg-slate-900/50 border border-slate-700 rounded-xl py-2 pl-10 pr-4 text-sm text-white focus:border-indigo-500 outline-none transition"
                            placeholder="Buscar por Nombre, WhatsApp o Notas...">
                    </div>

                    <!-- Filters -->
                    <div class="flex flex-wrap gap-2 w-full sm:w-auto">
                        <select id="filter-status" onchange="applyFilters()"
                            class="bg-slate-900/50 border border-slate-700 rounded-lg px-3 py-2 text-xs text-slate-300 focus:border-indigo-500 outline-none">
                            <option value="">Todos los Estados</option>
                            <option value="Lead">Lead</option>
                            <option value="Info_enviada">Info_enviada</option>
                            <option value="Reserva">Reserva</option>
                            <option value="Turista">Turista</option>
                            <option value="Cancelado">Cancelado</option>
                        </select>
                        <select id="filter-city" onchange="applyFilters()"
                            class="bg-slate-900/50 border border-slate-700 rounded-lg px-3 py-2 text-xs text-slate-300 focus:border-indigo-500 outline-none">
                            <option value="">Cargando ciudades...</option>
                        </select>

                        <!-- Export Button -->
                        <button onclick="openExportModal()"
                            class="bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg px-3 py-2 text-xs font-bold transition flex items-center gap-2 shadow-lg shadow-emerald-900/20">
                            <i class="fas fa-file-csv"></i> Exportar
                        </button>
                    </div>
                </div>

                <div class="glass-panel p-1 rounded-3xl border border-slate-700 shadow-2xl overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead
                                class="hidden md:table-header-group bg-slate-800 text-slate-400 font-bold uppercase text-xs sticky top-0 z-10">
                                <tr>
                                    <th class="p-4 text-left">ID</th>
                                    <th class="p-4 text-left">Nombre</th>
                                    <th class="p-4 text-left">WhatsApp</th>
                                    <th class="p-4 text-left">Ciudad</th>
                                    <th class="p-4 text-left">Tour</th>
                                    <th class="p-4 text-center">Estado</th>
                                    <th class="p-4 text-right">Monto</th>
                                </tr>
                            </thead>
                            <tbody id="full-table-body"
                                class="divide-y divide-slate-800 text-slate-300 bg-slate-900/40"></tbody>
                        </table>
                    </div>
                </div>


                <!-- PAGINATION CONTROLS -->
                <div class="flex flex-col sm:flex-row justify-between items-center gap-4 mt-4 text-slate-400 text-sm">
                    <span class="order-2 sm:order-1">
                        Mostrando <span id="page-info-start" class="font-bold text-white">0</span> - <span
                            id="page-info-end" class="font-bold text-white">0</span> de <span id="page-info-total"
                            class="font-bold text-white">0</span> contactos
                    </span>
                    <div class="flex gap-2 order-1 sm:order-2">
                        <button id="btn-first" onclick="goToPage(1)" disabled
                            class="px-3 py-2 bg-slate-800 hover:bg-slate-700 text-white rounded-lg disabled:opacity-50 disabled:cursor-not-allowed transition flex items-center gap-2"
                            title="Ir al Inicio">
                            <i class="fas fa-angle-double-left"></i> <span class="hidden sm:inline">Inicio</span>
                        </button>
                        <button id="btn-prev" onclick="changePage(-1)" disabled
                            class="px-4 py-2 bg-slate-800 hover:bg-slate-700 text-white rounded-lg disabled:opacity-50 disabled:cursor-not-allowed transition flex items-center gap-2">
                            <i class="fas fa-chevron-left"></i> Anterior
                        </button>
                        <button id="btn-next" onclick="changePage(1)" disabled
                            class="px-4 py-2 bg-slate-800 hover:bg-slate-700 text-white rounded-lg disabled:opacity-50 disabled:cursor-not-allowed transition flex items-center gap-2">
                            Siguiente <i class="fas fa-chevron-right"></i>
                        </button>
                        <button id="btn-last" onclick="goToPage('last')" disabled
                            class="px-3 py-2 bg-slate-800 hover:bg-slate-700 text-white rounded-lg disabled:opacity-50 disabled:cursor-not-allowed transition flex items-center gap-2"
                            title="Ir al Final">
                            <span class="hidden sm:inline">Final</span> <i class="fas fa-angle-double-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- VIEW: FORM -->
            <div id="view-form" class="hidden h-full flex flex-col justify-center items-center fade-in">
                <div class="w-full max-w-lg">
                    <div class="text-center mb-8">
                        <div
                            class="w-16 h-16 bg-emerald-500/10 text-emerald-500 rounded-2xl flex items-center justify-center text-3xl mx-auto mb-4 border border-emerald-500/20 shadow-[0_0_30px_rgba(16,185,129,0.2)]">
                            <i class="fas fa-user-plus"></i>
                        </div>
                        <h2 class="text-3xl font-black text-white mb-2">Nuevo Contacto</h2>
                        <p class="text-slate-400">Registra manualmente un lead para iniciar el flujo automático.</p>
                    </div>

                    <form id="contact-form" onsubmit="submitForm(event)" autocomplete="off"
                        class="glass-panel p-8 rounded-3xl space-y-5 border border-slate-700 shadow-2xl relative overflow-hidden">
                        <div id="form-loading"
                            class="absolute inset-0 bg-slate-900/80 z-20 hidden flex items-center justify-center flex-col gap-4 backdrop-blur-sm">
                            <div
                                class="w-10 h-10 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin">
                            </div>
                            <span class="font-bold text-emerald-400 animate-pulse">Enviando Datos...</span>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div class="space-y-2">
                                <label
                                    class="text-[10px] font-bold text-indigo-400 uppercase tracking-widest pl-1">Nombre</label>
                                <input type="text" name="nombre" required
                                    class="w-full bg-slate-950/50 border border-slate-700 rounded-xl p-3 text-sm focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none transition"
                                    placeholder="Ej: Juan Pérez">
                            </div>
                            <div class="space-y-2">
                                <label
                                    class="text-[10px] font-bold text-indigo-400 uppercase tracking-widest pl-1">WhatsApp</label>
                                <input type="tel" name="whatsapp" required
                                    class="w-full bg-slate-950/50 border border-slate-700 rounded-xl p-3 text-sm focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none transition"
                                    placeholder="Ej: 51999888777">
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div class="space-y-2">
                                <label class="text-[10px] font-bold text-indigo-400 uppercase tracking-widest pl-1">DNI
                                    / Pasaporte</label>
                                <input type="text" name="dni"
                                    class="w-full bg-slate-950/50 border border-slate-700 rounded-xl p-3 text-sm focus:border-indigo-500 outline-none transition"
                                    placeholder="Opcional">
                            </div>
                            <div class="space-y-2">
                                <label
                                    class="text-[10px] font-bold text-indigo-400 uppercase tracking-widest pl-1">Ciudad
                                    Origen</label>
                                <select name="ciudad" id="form-ciudad"
                                    class="w-full bg-slate-950 border border-slate-700 rounded-xl p-3 text-sm focus:border-indigo-500 outline-none transition text-slate-300">
                                    <option value="" disabled selected>Cargando ciudades...</option>
                                </select>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div class="space-y-2">
                                <label class="text-[10px] font-bold text-indigo-400 uppercase tracking-widest pl-1">Tour
                                    de Interés</label>
                                <!-- Form Multi-Select Container -->
                                <div id="form-tour-multiselect-container"
                                    class="w-full bg-slate-950/50 border border-slate-700 rounded-xl p-2 text-sm focus-within:border-indigo-500 focus-within:ring-1 focus-within:ring-indigo-500 transition relative">
                                    <div id="form-tags-list" class="flex flex-wrap gap-2 mb-2"></div>
                                    <div class="relative">
                                        <input type="text" id="form-tour-input"
                                            class="w-full bg-transparent border-none p-0 text-sm focus:ring-0 placeholder-slate-500 text-white"
                                            placeholder="Escribe para buscar..." autocomplete="off">
                                        <!-- Dropdown -->
                                        <div id="form-tour-dropdown"
                                            class="hidden absolute left-0 top-full mt-2 w-full bg-slate-900 border border-slate-700 rounded-lg shadow-xl z-50 max-h-48 overflow-y-auto">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- CHANGED: N° Personas -> PAX, Plus Start Date & Duration -->
                            <div class="space-y-2">
                                <label
                                    class="text-[10px] font-bold text-indigo-400 uppercase tracking-widest pl-1">PAX</label>
                                <input type="number" name="numero_personas" min="1"
                                    class="w-full bg-slate-950/50 border border-slate-700 rounded-xl p-3 text-sm focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none transition"
                                    placeholder="1">
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div class="space-y-2">
                                <label
                                    class="text-[10px] font-bold text-indigo-400 uppercase tracking-widest pl-1">Inicio
                                    Tour</label>
                                <input type="date" name="fecha_inicio_tour" id="form-inicio-tour"
                                    class="w-full bg-slate-950/50 border border-slate-700 rounded-xl p-3 text-sm focus:border-indigo-500 text-slate-300 outline-none transition">
                            </div>
                            <div class="space-y-2">
                                <label
                                    class="text-[10px] font-bold text-indigo-400 uppercase tracking-widest pl-1">Duración
                                    (Días)</label>
                                <input type="number" name="duracion_dias_tour" min="1"
                                    class="w-full bg-slate-950/50 border border-slate-700 rounded-xl p-3 text-sm focus:border-indigo-500 outline-none transition"
                                    placeholder="Ej: 3">
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div class="space-y-2">
                                <label
                                    class="text-[10px] font-bold text-indigo-400 uppercase tracking-widest pl-1">Estado
                                    Contacto</label>
                                <select name="estado" id="form-estado"
                                    class="w-full bg-slate-950 border border-slate-700 rounded-xl p-3 text-sm focus:border-indigo-500 outline-none transition text-slate-300">
                                    <option value="Lead">Lead</option>
                                    <option value="Reserva">Reserva</option>
                                    <option value="Turista">Turista</option>
                                    <option value="Completado">Completado</option>
                                </select>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div class="space-y-2">
                                <label
                                    class="text-[10px] font-bold text-indigo-400 uppercase tracking-widest pl-1">Punto
                                    de Embarque</label>
                                <input type="text" name="punto_embarque"
                                    class="w-full bg-slate-950/50 border border-slate-700 rounded-xl p-3 text-sm focus:border-indigo-500 outline-none transition"
                                    placeholder="Lugar de recojo">
                            </div>
                            <div class="space-y-2">
                                <label
                                    class="text-[10px] font-bold text-indigo-400 uppercase tracking-widest pl-1">Monto
                                    Cotizado (S/)</label>
                                <input type="number" step="0.1" name="monto"
                                    class="w-full bg-slate-950/50 border border-slate-700 rounded-xl p-3 text-sm focus:border-indigo-500 outline-none transition"
                                    placeholder="0.00">
                            </div>
                        </div>

                        <div class="space-y-2">
                            <label class="text-[10px] font-bold text-indigo-400 uppercase tracking-widest pl-1">Notas /
                                Observaciones</label>
                            <textarea name="notas" rows="2"
                                class="w-full bg-slate-950/50 border border-slate-700 rounded-xl p-3 text-sm focus:border-indigo-500 outline-none transition"
                                placeholder="Detalles adicionales..."></textarea>
                        </div>



                        <button type="submit"
                            class="w-full py-4 bg-emerald-600 hover:bg-emerald-500 text-white rounded-xl font-bold shadow-lg shadow-emerald-900/50 transition transform active:scale-95 flex items-center justify-center gap-2 mt-4 group">
                            <span>REGISTRAR CONTACTO</span>
                            <i class="fas fa-paper-plane group-hover:translate-x-1 transition"></i>
                        </button>
                    </form>
                </div>
            </div>

        </div>
    </main>

    <!-- NOTIFICATION SYSTEM -->
    <div id="toast-container" class="fixed bottom-5 right-5 z-50 flex flex-col gap-3 pointer-events-none"></div>

    <!-- CONTACT DETAILS MODAL -->
    <div id="contact-modal" class="fixed inset-0 z-[60] hidden" aria-labelledby="modal-title" role="dialog"
        aria-modal="true">
        <!-- Backdrop -->
        <div class="fixed inset-0 bg-slate-950/80 backdrop-blur-sm transition-opacity opacity-0" id="modal-backdrop">
        </div>

        <div class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                <!-- Modal Panel -->
                <div class="relative transform overflow-hidden rounded-2xl bg-slate-900 border border-slate-700 text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-2xl opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                    id="modal-panel">

                    <!-- Header -->
                    <div class="bg-slate-800/50 px-6 py-4 border-b border-slate-700 flex justify-between items-center">
                        <div>
                            <h3 class="text-xl font-bold text-white" id="modal-title">Detalles del Contacto</h3>
                            <p class="text-sm text-slate-400 mt-1" id="modal-id">C-000000</p>
                        </div>
                        <button type="button" onclick="closeContactModal()"
                            class="text-slate-400 hover:text-white transition">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>

                    <!-- Body -->
                    <div class="px-6 py-6 space-y-6">
                        <!-- Main Info -->
                        <div class="flex items-start gap-4">
                            <div
                                class="w-16 h-16 rounded-full bg-indigo-500/20 flex items-center justify-center text-indigo-400 text-2xl font-bold shrink-0">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="flex-1 space-y-3">
                                <input type="text" id="modal-nombre" disabled
                                    class="w-full bg-transparent border-none text-2xl font-bold text-white focus:bg-slate-800/50 focus:ring-2 focus:ring-indigo-500 rounded p-1 transition"
                                    value="Nombre Completo">

                                <div class="flex flex-wrap gap-3">
                                    <div class="relative">
                                        <i
                                            class="fab fa-whatsapp absolute left-3 top-1/2 -translate-y-1/2 text-emerald-400 text-xs"></i>
                                        <input type="text" id="modal-whatsapp" disabled
                                            class="pl-8 w-40 bg-emerald-500/10 border border-emerald-500/20 text-emerald-400 text-xs font-medium rounded-full py-1 focus:bg-slate-800 disabled:opacity-100"
                                            value="+51 999 999 999">
                                    </div>
                                    <div class="relative">
                                        <i
                                            class="fas fa-map-marker-alt absolute left-3 top-1/2 -translate-y-1/2 text-blue-400 text-xs"></i>
                                        <select id="modal-ciudad" disabled
                                            class="pl-8 appearance-none bg-blue-500/10 border border-blue-500/20 text-blue-400 text-xs font-medium rounded-full py-1 pr-4 focus:bg-slate-800 disabled:opacity-100">
                                            <option value="">Cargando...</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Grid Details -->
                        <div
                            class="grid grid-cols-1 sm:grid-cols-2 gap-6 bg-slate-950/30 p-4 rounded-xl border border-slate-800">
                            <div>
                                <label
                                    class="text-[10px] uppercase tracking-wider text-slate-500 font-bold block mb-1">Tours
                                    de Interés</label>
                                <!-- Tag Input Container -->
                                <div id="tour-multiselect-container"
                                    class="w-full bg-transparent border-none text-slate-200 font-medium text-sm p-0 focus-within:ring-0 relative">
                                    <!-- Selected Tags -->
                                    <div id="tour-tags-list" class="flex flex-wrap gap-2 mb-2"></div>

                                    <!-- Input & Dropdown -->
                                    <div class="relative group">
                                        <input type="text" id="tour-input" disabled
                                            class="w-full bg-slate-800/50 rounded-lg px-2 py-1 text-sm border border-slate-700 focus:border-indigo-500 outline-none disabled:bg-transparent disabled:border-none disabled:p-0 transition placeholder-slate-600"
                                            placeholder="Añadir tour..." autocomplete="off">

                                        <!-- Dropdown (Hidden via CSS initially) -->
                                        <div id="tour-dropdown-list"
                                            class="hidden absolute left-0 top-full mt-1 w-full bg-slate-800 border border-slate-700 rounded-lg shadow-xl z-50 max-h-48 overflow-y-auto">
                                            <!-- Options populated by JS -->
                                        </div>
                                    </div>
                                    <!-- Hidden input to store CSV for traditional form access if needed, though we use state -->
                                </div>
                            </div>
                            <div>
                                <label
                                    class="text-[10px] uppercase tracking-wider text-slate-500 font-bold block mb-1">Estado</label>
                                <select id="modal-estado" disabled
                                    class="w-full bg-slate-900 border-none text-xs font-medium text-slate-300 p-0 focus:ring-0 disabled:opacity-100 uppercase disabled:bg-transparent">
                                    <option value="Lead">Lead</option>
                                    <option value="Reserva">Reserva</option>
                                    <option value="Turista">Turista</option>
                                    <option value="Completado">Completado</option>
                                </select>
                            </div>
                            <div>
                                <label
                                    class="text-[10px] uppercase tracking-wider text-slate-500 font-bold block mb-1">DNI
                                    / Pasaporte</label>
                                <input type="text" id="modal-dni" disabled autocomplete="off"
                                    class="w-full bg-transparent border-none text-slate-200 font-mono text-sm p-0 focus:ring-0 disabled:opacity-100"
                                    value="-">
                            </div>
                            <div>
                                <label
                                    class="text-[10px] uppercase tracking-wider text-slate-500 font-bold block mb-1">Monto
                                    Cotizado</label>
                                <div class="flex items-center text-emerald-400 font-bold text-lg">
                                    <span>S/</span>
                                    <input type="number" id="modal-monto" disabled autocomplete="off"
                                        class="ml-2 w-24 bg-transparent border-none text-emerald-400 font-bold p-0 focus:ring-0 disabled:opacity-100"
                                        value="0.00">
                                </div>
                            </div>
                            <div>
                                <label
                                    class="text-[10px] uppercase tracking-wider text-slate-500 font-bold block mb-1">PAX</label>
                                <input type="number" id="modal-personas" disabled autocomplete="off"
                                    class="w-full bg-transparent border-none text-slate-200 text-sm p-0 focus:ring-0 disabled:opacity-100"
                                    placeholder="1">
                            </div>
                            <div>
                                <label
                                    class="text-[10px] uppercase tracking-wider text-slate-500 font-bold block mb-1">Duración
                                    (Días)</label>
                                <input type="number" id="modal-dias-tour" disabled autocomplete="off"
                                    class="w-full bg-transparent border-none text-slate-200 text-sm p-0 focus:ring-0 disabled:opacity-100"
                                    placeholder="1">
                            </div>
                            <div>
                                <label
                                    class="text-[10px] uppercase tracking-wider text-slate-500 font-bold block mb-1">Punto
                                    de Embarque</label>
                                <input type="text" id="modal-embarque" disabled
                                    class="w-full bg-transparent border-none text-slate-200 text-sm p-0 focus:ring-0 disabled:opacity-100"
                                    value="-">
                            </div>
                            <div>
                                <label
                                    class="text-[10px] uppercase tracking-wider text-slate-500 font-bold block mb-1">Inicio
                                    Tour</label>
                                <input type="date" id="modal-inicio-tour" disabled
                                    class="w-full bg-transparent border-none text-slate-200 text-sm p-0 focus:ring-0 disabled:opacity-100">
                            </div>
                            <div>
                                <label
                                    class="text-[10px] uppercase tracking-wider text-slate-500 font-bold block mb-1">Último
                                    Contacto</label>
                                <p class="text-slate-500 text-sm" id="modal-fecha-contacto">-</p>
                            </div>
                        </div>

                        <!-- Notes & Meta -->
                        <div>
                            <label
                                class="text-[10px] uppercase tracking-wider text-slate-500 font-bold block mb-2">Notas /
                                Observaciones</label>
                            <textarea id="modal-notas" disabled rows="2"
                                class="w-full bg-slate-800/50 rounded-lg p-3 text-sm text-slate-300 italic min-h-[60px] border-none focus:ring-1 focus:ring-indigo-500 disabled:resize-none"></textarea>
                        </div>

                        <div
                            class="border-t border-slate-800 pt-4 flex justify-between items-center text-xs text-slate-500">
                            <span id="modal-origen">Origen: web_dashboard</span>
                            <span id="modal-registro">Registrado: -</span>
                        </div>
                    </div>

                    <!-- Footer -->
                    <div class="bg-slate-800/50 px-6 py-4 flex justify-end gap-3 border-t border-slate-700">
                        <!-- View Mode Buttons -->
                        <div id="modal-btns-view" class="flex gap-3">
                            <button type="button" onclick="closeContactModal()"
                                class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg text-sm font-medium transition">
                                Cerrar
                            </button>
                            <button type="button" onclick="enableEditMode()"
                                class="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg text-sm font-medium transition flex items-center gap-2 shadow-lg shadow-indigo-900/20">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                            <a href="#" id="modal-btn-wsp" target="_blank"
                                class="px-4 py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg text-sm font-medium transition flex items-center gap-2 shadow-lg shadow-emerald-900/20">
                                <i class="fab fa-whatsapp"></i> Contactar
                            </a>
                        </div>

                        <!-- Edit Mode Buttons -->
                        <div id="modal-btns-edit" class="hidden flex gap-3">
                            <button type="button" onclick="disableEditMode()"
                                class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg text-sm font-medium transition">
                                Cancelar
                            </button>
                            <button type="button" onclick="saveContactChanges()"
                                class="px-4 py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg text-sm font-medium transition flex items-center gap-2 shadow-lg shadow-emerald-900/20 animate-pulse">
                                <i class="fas fa-save"></i> Guardar Cambios
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- EXPORT MODAL -->
    <div id="export-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
        <div id="export-backdrop" class="absolute inset-0 bg-black/80 backdrop-blur-sm transition-opacity opacity-0">
        </div>
        <div id="export-panel"
            class="relative bg-slate-900 border border-slate-700 rounded-2xl w-full max-w-sm p-6 shadow-2xl transform transition-all scale-95 opacity-0 translate-y-4">
            <h3 class="text-xl font-bold text-white mb-4">Exportar Contactos</h3>

            <div class="space-y-4">
                <!-- Option 1: Month -->
                <div>
                    <label class="text-xs text-slate-400 font-bold uppercase block mb-2">Por Mes</label>
                    <input type="month" id="export-month"
                        class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white text-sm focus:border-emerald-500 outline-none">
                    <button onclick="downloadExport('month')"
                        class="mt-2 w-full bg-slate-700 hover:bg-slate-600 text-white py-2 rounded-lg text-sm transition">Descargar
                        Mes</button>
                </div>

                <div class="border-t border-slate-800"></div>

                <!-- Option 2: Day -->
                <div>
                    <label class="text-xs text-slate-400 font-bold uppercase block mb-2">Por Día</label>
                    <input type="date" id="export-day"
                        class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white text-sm focus:border-emerald-500 outline-none">
                    <button onclick="downloadExport('day')"
                        class="mt-2 w-full bg-slate-700 hover:bg-slate-600 text-white py-2 rounded-lg text-sm transition">Descargar
                        Día</button>
                </div>

                <div class="border-t border-slate-800"></div>

                <!-- Option 3: All -->
                <button onclick="downloadExport('all')"
                    class="w-full bg-emerald-600 hover:bg-emerald-500 text-white py-3 rounded-lg font-bold shadow-lg shadow-emerald-900/20 transition">
                    Descargar Todo
                </button>
            </div>

            <button onclick="closeExportModal()" class="absolute top-4 right-4 text-slate-500 hover:text-white">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <!-- TOAST CONTAINER -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-[9999] flex flex-col gap-2 pointer-events-none"></div>

    <script>
        // --- CONSTANTS 
        const SHEET_CSV_CONTACTOS = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRBnkhcj5Gp9QMwMJmr1p1z6gcw3wShIC247dJ3V3qzwkEwkZEwJqroj3LIh826G4CaPBdZQAEIGoD0/pub?gid=0&single=true&output=csv';
        const SHEET_CSV_PAQUETES = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRBnkhcj5Gp9QMwMJmr1p1z6gcw3wShIC247dJ3V3qzwkEwkZEwJqroj3LIh826G4CaPBdZQAEIGoD0/pub?gid=245309544&single=true&output=csv';
        // Using direct gviz URL for the new tab as it might not be published to web as 'pub' yet, or just for consistency with manual GID provided.
        // Actually, for public sheets, the /pub?gid=... format is often used for 'Published to Web'.
        // But the user gave me a GID from the edit URL. The safest and most immediate way for private-ish sheets that are shared with "Anyone with link" is often gviz or the export call.
        // Let's use the export format which consistently works for GIDs if the sheet is open.
        // https://docs.google.com/spreadsheets/d/[ID]/export?format=csv&gid=[GID]
        // But the existing ones use /pub? which implies "File > Share > Publish to Web".
        // The user might not have "Published to Web" the specific tab.
        // I'll try the /export format first which is usually robust if the sheet is generally public/shared.
        // ID: 16qnWmfEMjb0OJ_I_xMypB279m_a5jOg1V1l1sqbCcNA
        // GID: 127481278
        const SHEET_CSV_CIUDADES = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRBnkhcj5Gp9QMwMJmr1p1z6gcw3wShIC247dJ3V3qzwkEwkZEwJqroj3LIh826G4CaPBdZQAEIGoD0/pub?gid=127481278&single=true&output=csv';
        const WEBHOOK_URL = 'https://nonisotropic-ungrindable-kristie.ngrok-free.dev/webhook/update-dashboard'; // Public Tunnel URL for Netlify

        // --- STATE ---
        let state = {
            contactos: [],
            paquetes: [],
            ciudades: [], // Added cities state
            filteredContactos: [],
            currentPage: 1,
            rowsPerPage: 10,
            loading: true,
            globalFilter: '30d' // '30d' or 'general'
        };

        // --- CHART INSTANCES ---
        let charts = {};

        // --- INITIALIZATION ---
        // --- INITIALIZATION ---
        window.onload = () => {
            // 1. Start fetching data in background (do not await)
            Promise.all([
                fetchData(SHEET_CSV_CONTACTOS, 'contactos'),
                fetchData(SHEET_CSV_PAQUETES, 'paquetes'),
                fetchData(SHEET_CSV_CIUDADES, 'ciudades')
            ]).then(() => {
                console.log("All data loaded.");
                initUI(); // MOVED HERE: Only init UI when data is ready
                updateDashboard();
            });

            // 2. Initialize UI mechanisms immediately - REMOVED from here to avoid race condition
            try {
                setupTourInput();
            } catch (e) {
                console.error("Setup Tour Input Failed:", e);
            }

            // 3. Run Magic Link Check immediately (it has its own retry logic)
            // This ensures feedback appears INSTANTLY to the user
            try {
                checkUrlForMagicLink();
            } catch (e) {
                console.error("Magic Link Failed:", e);
                showToast("Error procesando enlace de cliente", "error");
            }
        };

        // --- MAGIC LINK LOGIC ---
        async function checkUrlForMagicLink(retryCount = 0) {
            const params = new URLSearchParams(window.location.search);
            let phone = params.get('telefono');

            if (phone) {
                // Switch to leads view immediately
                switchView('leads');

                // Normalize query phone
                const cleanQuery = phone.replace(/\D/g, '').slice(-9);
                console.log(`Magic Link: ${cleanQuery} (Attempt ${retryCount + 1})`);

                // If data not loaded, show waiting toast and retry
                if ((!state.contactos || state.contactos.length === 0)) {
                    // Show scanning toast on first attempt
                    if (retryCount === 0) showToast(`Buscando cliente ${cleanQuery}...`, 'info');

                    if (retryCount < 10) { // Retry for 10 seconds
                        console.log("Contacts not loaded yet, retrying in 1s...");
                        setTimeout(() => checkUrlForMagicLink(retryCount + 1), 1000);
                        return;
                    } else {
                        showToast("Error: No se pudieron cargar los contactos.", "error");
                        return;
                    }
                }

                // DEBUG: Show what columns we actually have (in console)
                if (retryCount === 0 && state.contactos.length > 0) {
                    const keys = Object.keys(state.contactos[0]).join(', ');
                    console.log("CSV Headers:", keys);
                }

                const contact = state.contactos.find(c => {
                    // Strict Match (Legacy Logic from revisa.html)
                    if (!c.Numero_whatsapp) return false;
                    const cleanContact = c.Numero_whatsapp.replace(/\D/g, '').slice(-9);
                    return cleanContact === cleanQuery;
                });

                if (contact) {
                    showToast(`Cliente encontrado: ${contact.Nombre}`, 'success');
                    console.log("Contact match found:", contact);

                    // Small delay to allow view transition
                    setTimeout(() => {
                        openContactModal(contact.ID);
                        // Clean URL after successful open but keep history state clean
                        const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
                        window.history.replaceState({ path: newUrl }, '', newUrl);

                        setTimeout(() => {
                            enableEditMode();
                        }, 300);
                    }, 500);
                } else {
                    console.warn("No match found for", cleanQuery);
                    if (state.contactos.length > 0) {
                        showToast(`No se encontró cliente con celular: ${cleanQuery}`, 'error');
                    }
                }
            }
        }

        // --- DATA FETCHING ---
        async function fetchData(url, key) {
            return new Promise((resolve) => {
                Papa.parse(url, {
                    download: true,
                    header: true,
                    skipEmptyLines: true,
                    complete: function (results) {
                        state[key] = results.data;
                        console.log(`Loaded ${key}:`, state[key].length);
                        resolve();
                    },
                    error: function (err) {
                        console.error(`Error loading ${key}`, err);
                        showToast(`Error cargando ${key}`, 'error');
                        resolve(); // Resolve anyway to not block UI
                    }
                });
            });
        }

        async function refreshData() {
            const btn = document.getElementById('refresh-icon');
            btn.classList.add('animate-spin');

            // Fix: Include Cities in refresh
            await Promise.all([
                fetchData(SHEET_CSV_CONTACTOS, 'contactos'),
                fetchData(SHEET_CSV_PAQUETES, 'paquetes'),
                fetchData(SHEET_CSV_CIUDADES, 'ciudades')
            ]);

            // Re-init UI to populate selects with potentially new cities
            initUI();

            updateDashboard();
            btn.classList.remove('animate-spin');
            showToast('Datos actualizados', 'success');
        }

        // --- UI LOGIC ---
        function initUI() {
            console.log("Initializing UI with Cities:", state.ciudades ? state.ciudades.length : 0);

            if (!state.ciudades) return; // Safety check

            // Populate Cities (Filter, Modal, Form)
            // Robust extraction: Check for 'ciudad', 'Ciudad', 'CIUDAD'
            const cityOptions = state.ciudades.map(c => {
                return c.ciudad || c.Ciudad || c.CIUDAD || '';
            }).filter(c => c && c.trim() !== '');

            // Remove duplicates and sort
            const uniqueCities = [...new Set(cityOptions)];

            // Priority Cities
            const priority = ['Lima', 'Huancayo', 'Tingo María'];

            uniqueCities.sort((a, b) => {
                const idxA = priority.indexOf(a);
                const idxB = priority.indexOf(b);

                // If both are priority, sort by priority index
                if (idxA !== -1 && idxB !== -1) return idxA - idxB;
                // If one is priority, it comes first
                if (idxA !== -1) return -1;
                if (idxB !== -1) return 1;
                // Otherwise alpha sort
                return a.localeCompare(b);
            });

            console.log("Parsed Unique Cities (Sorted):", uniqueCities);

            const citySelects = ['filter-city', 'modal-ciudad', 'form-ciudad'];

            citySelects.forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;

                // Determine default first option
                let defaultTxt = (id === 'filter-city') ? 'Todas las Ciudades' : 'Selecciona Ciudad...';
                let defaultVal = (id === 'filter-city') ? '' : '';

                // Keep existing selection if any (for refreshes)
                const currentVal = el.value;

                let html = `<option value="${defaultVal}" ${id !== 'filter-city' ? 'disabled' : ''}>${defaultTxt}</option>`;

                uniqueCities.forEach(city => {
                    html += `<option value="${city}">${city}</option>`;
                });

                // Add 'Otro' if not present
                if (!uniqueCities.includes('Otro')) {
                    html += `<option value="Otro">Otro</option>`;
                }

                el.innerHTML = html;

                // Restore selection if sensible
                if (currentVal && (uniqueCities.includes(currentVal) || currentVal === 'Otro')) {
                    el.value = currentVal;
                } else if (id !== 'filter-city') {
                    // Ensure modal select placeholder is selected if value is invalid
                    el.value = defaultVal;
                }
            });
        }

        function updateDashboard() {
            // Show/Hide Global Filter based on View
            const filterDiv = document.getElementById('global-date-filter');
            const overview = document.getElementById('view-overview');
            if (filterDiv && overview) {
                if (!overview.classList.contains('hidden')) filterDiv.classList.remove('hidden', 'md:flex'); // Restore flex
                else filterDiv.classList.add('hidden');
            }

            updateKPIs();
            renderCharts();
            renderTablePreview();
            applyFilters();
        }

        // --- GLOBAL FILTER LOGIC ---
        function setGlobalFilter(mode) {
            state.globalFilter = mode;

            // Visual Update
            const btn30 = document.getElementById('btn-filter-30d');
            const btnGen = document.getElementById('btn-filter-general');

            if (mode === '30d') {
                btn30.className = 'px-3 py-1 text-xs font-bold rounded-md transition bg-indigo-600 text-white shadow-lg';
                btnGen.className = 'px-3 py-1 text-xs font-bold rounded-md transition text-slate-400 hover:text-white hover:bg-slate-700';
            } else {
                btnGen.className = 'px-3 py-1 text-xs font-bold rounded-md transition bg-indigo-600 text-white shadow-lg';
                btn30.className = 'px-3 py-1 text-xs font-bold rounded-md transition text-slate-400 hover:text-white hover:bg-slate-700';
            }

            updateDashboard();
        }

        function getAnalysisData() {
            if (state.globalFilter === 'general') return state.contactos;

            // 30 Days Logic
            const limit = new Date();
            limit.setDate(limit.getDate() - 30);
            limit.setHours(0, 0, 0, 0);

            return state.contactos.filter(c => {
                const d = c.Fecha_registro ? new Date(c.Fecha_registro.replace(/-/g, '/')) : new Date(0);
                return d >= limit;
            });
        }

        function updateKPIs() {
            const data = getAnalysisData();

            // 1. Ingresos (Estimated) - Sum of visible data
            const total = data.reduce((sum, c) => {
                if (c.Estado_contacto !== 'Cancelado') {
                    return sum + (parseFloat(c.Monto_cotizado) || 0);
                }
                return sum;
            }, 0);
            document.getElementById('kpi-ingresos').innerText = `S/ ${total.toLocaleString('es-PE', { minimumFractionDigits: 0 })}`;

            // 2. Turistas / Oportunidad
            let tourists = 0;
            let opportunity = 0;

            data.forEach(c => {
                const pax = parseInt(c.PAX) || 1;
                opportunity += pax;
                if (c.Estado_contacto === 'Turista' || c.Estado_contacto === 'Completado') {
                    tourists += pax;
                }
            });
            document.getElementById('kpi-leads').innerText = `${tourists} / ${opportunity}`;

            // 3. Top Package
            const counts = {};
            data.forEach(c => {
                if (c.Estado_contacto === 'Cancelado') return;

                let rawTours = c.Tour_interes || '';
                if (!rawTours.trim()) return; // Ignore empty

                // Split logic
                const tourList = rawTours.split(',').map(t => t.trim()).filter(t => t);
                if (tourList.length === 0) return;

                // Weight by PAX to match Chart logic consistency
                const pax = parseInt(c.PAX) || 1;

                tourList.forEach(t => {
                    counts[t] = (counts[t] || 0) + pax;
                });
            });
            const topPkg = Object.entries(counts).sort((a, b) => b[1] - a[1])[0];
            document.getElementById('kpi-top-package').innerText = topPkg ? topPkg[0] : 'N/A';

            // 4. Top City (Origen Principal) -> FILTERED
            const cities = {};
            data.forEach(c => {
                // FILTER: Only Turista or Completado
                if (c.Estado_contacto !== 'Turista' && c.Estado_contacto !== 'Completado') return;

                let city = c.Ciudad_contacto || 'Desconocido';
                cities[city] = (cities[city] || 0) + (parseInt(c.PAX) || 1); // Weight by PAX for "Most Affluence"
            });
            const topCity = Object.entries(cities).sort((a, b) => b[1] - a[1])[0];
            document.getElementById('kpi-top-city').innerText = topCity ? topCity[0] : 'N/A';
        }

        function renderCharts() {
            renderTimelineChart();
            renderOriginChart();
            renderPackagesChart();
            renderForecastChart();
        }



        function renderTimelineChart() {
            const ctxWrapper = document.getElementById('chart-timeline');
            if (!ctxWrapper) return;
            const ctx = ctxWrapper.getContext('2d');
            if (charts.timeline) charts.timeline.destroy();

            const isGeneral = state.globalFilter === 'general';
            const data = getAnalysisData();
            const grouped = {};

            // Update Chart Title based on Filter
            // Note: Canvas doesn't change title, but we can change the DOM element if we want.
            // For now, let's just make sure the data is right.

            data.forEach(c => {
                if (!c.Fecha_registro) return;
                // Parse date
                let d = c.Fecha_registro.split(' ')[0]; // YYYY-MM-DD

                let key;
                if (isGeneral) {
                    // YYYY-MM
                    const parts = d.split('-');
                    if (parts.length >= 2) key = `${parts[0]}-${parts[1]}`;
                    else key = d;
                } else {
                    key = d; // Daily
                }

                const pax = parseInt(c.PAX) || 1;
                grouped[key] = (grouped[key] || 0) + pax;
            });

            // Sort dates strictly by key (YYYY-MM-DD or YYYY-MM) to ensure chronological order
            const allKeys = Object.keys(grouped).sort();

            // Generate Display Labels (Remove Year)
            // If Key is YYYY-MM-DD -> MM-DD
            // If Key is YYYY-MM -> MM
            const displayLabels = allKeys.map(k => {
                const parts = k.split('-');
                if (parts.length === 3) return `${parts[1]}-${parts[2]}`; // MM-DD
                if (parts.length === 2) return `${parts[1]}`; // MM (Monthly view)
                return k;
            });

            const datasetsData = allKeys.map(k => grouped[k]);

            charts.timeline = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: displayLabels, // Use formatted labels
                    datasets: [{
                        label: 'PAX',
                        data: datasetsData,
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return `PAX: ${context.raw}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#334155' },
                            ticks: { stepSize: 1, precision: 0 }
                        },
                        x: { grid: { display: false }, ticks: { color: '#94a3b8' } }
                    }
                }
            });
        }

        function renderOriginChart() {
            const ctxWrapper = document.getElementById('chart-origin');
            if (!ctxWrapper) return;
            const ctx = ctxWrapper.getContext('2d');
            if (charts.origin) charts.origin.destroy();

            const cities = {};
            const data = getAnalysisData(); // Use Filtered Data

            // Generate distinct colors dynamically
            const colors = [
                '#f43f5e', '#8b5cf6', '#10b981', '#f59e0b', '#3b82f6',
                '#ec4899', '#6366f1', '#14b8a6', '#84cc16', '#64748b',
                '#a855f7', '#06b6d4', '#22c55e', '#eab308', '#f97316'
            ];

            data.forEach(c => {
                // FILTER: Only Turista or Completado
                if (c.Estado_contacto !== 'Turista' && c.Estado_contacto !== 'Completado') return;

                let city = c.Ciudad_contacto ? c.Ciudad_contacto.trim() : 'Desconocido';
                if (!city) city = 'Desconocido';

                const pax = parseInt(c.PAX) || 1;
                cities[city] = (cities[city] || 0) + pax;
            });

            const labels = Object.keys(cities);
            const values = Object.values(cities);

            // Assign colors cyclically
            const bgColors = labels.map((_, i) => colors[i % colors.length]);

            charts.origin = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: bgColors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top', labels: { color: '#cbd5e1', font: { size: 10 }, boxWidth: 10 } }
                    },
                    cutout: '70%',
                    layout: { padding: 0 }
                }
            });
        }

        function renderPackagesChart() {
            const ctxWrapper = document.getElementById('chart-packages');
            if (!ctxWrapper) return;
            const ctx = ctxWrapper.getContext('2d');
            if (charts.pkg) charts.pkg.destroy();

            const counts = {};
            const data = getAnalysisData(); // Use Global Filter

            data.forEach(c => {
                if (c.Estado_contacto === 'Cancelado') return;

                let rawTours = c.Tour_interes || '';
                // FILTER: Ignore empty tours (Leads)
                if (!rawTours.trim()) return;

                // Split by comma to handle multiple tours (e.g., "Trilogia, Maravilla")
                const tourList = rawTours.split(',').map(t => t.trim()).filter(t => t);

                if (tourList.length === 0) return;

                const pax = parseInt(c.PAX) || 1;

                tourList.forEach(t => {
                    counts[t] = (counts[t] || 0) + pax;
                });
            });

            const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]).slice(0, 5);

            // Polar Area Colors
            const polarColors = [
                'hsla(250, 70%, 65%, 0.7)',
                'hsla(190, 80%, 60%, 0.7)',
                'hsla(320, 70%, 60%, 0.7)',
                'hsla(40, 90%, 60%, 0.7)',
                'hsla(150, 60%, 50%, 0.7)'
            ];
            const polarBorders = [
                'hsla(250, 70%, 50%, 1)',
                'hsla(190, 80%, 45%, 1)',
                'hsla(320, 70%, 45%, 1)',
                'hsla(40, 90%, 45%, 1)',
                'hsla(150, 60%, 35%, 1)'
            ];

            charts.pkg = new Chart(ctx, {
                type: 'polarArea', // RESTORED POLAR AREA
                data: {
                    labels: sorted.map(i => i[0].length > 15 ? i[0].substring(0, 15) + '...' : i[0]),
                    datasets: [{
                        label: 'PAX',
                        data: sorted.map(i => i[1]),
                        backgroundColor: polarColors,
                        borderColor: polarBorders,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top', labels: { color: '#cbd5e1', font: { size: 10 } } },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return ` ${context.label}: ${context.raw} PAX`;
                                }
                            }
                        }
                    },
                    scales: {
                        r: {
                            grid: { color: '#334155' },
                            ticks: { display: false, backdropColor: 'transparent' },
                            pointLabels: { display: false }
                        }
                    }
                }
            });
        }

        function renderTablePreview() {
            const tbody = document.getElementById('table-preview-body');
            tbody.innerHTML = '';

            // Filter: Only 'Reserva' or 'Turista' (Case Insensitive)
            const valid = state.contactos.filter(c => {
                const status = (c.Estado_contacto || '').trim().toLowerCase();
                return status === 'reserva' || status === 'turista';
            });

            // Sort by ID descending (Latest first)
            const sorted = valid.sort((a, b) => {
                const idA = parseInt((a.ID || '0').replace(/\D/g, ''));
                const idB = parseInt((b.ID || '0').replace(/\D/g, ''));
                return idB - idA;
            });

            const last5 = sorted.slice(0, 5);

            if (last5.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center text-xs text-slate-500 py-4">No hay reservas recientes</td></tr>';
            }

            last5.forEach(c => {
                // Stack Tours Logic
                const tours = (c.Tour_interes || '-').split(',').map(t => t.trim()).join('<br>');

                tbody.innerHTML += `
                    <tr class="hover:bg-slate-800/10 transition border-b border-slate-700/50 cursor-pointer" onclick="openContactModal('${c.ID}')">
                        <td class="py-3 pl-2 max-w-[120px] truncate font-medium text-white" title="${c.Nombre}">${c.Nombre}</td>
                        <td class="py-3 text-center text-[10px] text-slate-400 font-mono leading-tight">${tours}</td>
                        <td class="py-3 text-right text-emerald-400 font-bold text-xs">${c.Monto_cotizado ? 'S/' + c.Monto_cotizado : '-'}</td>
                    </tr>
                `;
            });
        }






        // --- MULTI-SELECT TOURS LOGIC ---
        let currentTours = [];

        function renderTours() {
            const list = document.getElementById('tour-tags-list');
            list.innerHTML = '';
            currentTours.forEach((tour, index) => {
                const tag = document.createElement('div');
                tag.className = 'bg-indigo-500/20 text-indigo-300 border border-indigo-500/30 rounded-md px-2 py-1 text-xs font-bold flex items-center gap-1';
                tag.innerHTML = `
                    <span>${tour}</span>
                    <button onclick="removeTour(${index})" class="hover:text-white transition focus:outline-none">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                list.appendChild(tag);
            });
        }

        function addTour(tourName) {
            const t = tourName.trim();
            if (t && !currentTours.includes(t)) {
                currentTours.push(t);
                renderTours();
                document.getElementById('tour-input').value = '';
                document.getElementById('tour-dropdown-list').classList.add('hidden');
            }
        }

        function removeTour(index) {
            currentTours.splice(index, 1);
            renderTours();
        }

        // --- MULTI-SELECT TOURS LOGIC (FORM) ---
        let formTours = [];

        function renderFormTours() {
            const list = document.getElementById('form-tags-list');
            list.innerHTML = '';
            formTours.forEach((tour, index) => {
                const tag = document.createElement('div');
                tag.className = 'bg-indigo-500/20 text-indigo-300 border border-indigo-500/30 rounded-md px-2 py-1 text-xs font-bold flex items-center gap-1';
                tag.innerHTML = `
                    <span>${tour}</span>
                    <button type="button" onclick="removeFormTour(${index})" class="hover:text-white transition focus:outline-none">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                list.appendChild(tag);
            });
        }

        function addFormTour(tourName) {
            const t = tourName.trim();
            if (t && !formTours.includes(t)) {
                formTours.push(t);
                renderFormTours();
                document.getElementById('form-tour-input').value = '';
                document.getElementById('form-tour-dropdown').classList.add('hidden');
            }
        }

        function removeFormTour(index) {
            formTours.splice(index, 1);
            renderFormTours();
        }

        // Setup Tour Input Event Listeners
        function setupTourInput() {
            // MODAL INPUT
            const input = document.getElementById('tour-input');
            const dropdown = document.getElementById('tour-dropdown-list');

            input.addEventListener('focus', () => {
                if (!input.disabled) {
                    renderDropdown(input.value, dropdown, false);
                    dropdown.classList.remove('hidden');
                }
            });

            input.addEventListener('input', (e) => {
                renderDropdown(e.target.value, dropdown, false);
                dropdown.classList.remove('hidden');
            });
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addTour(input.value);
                }
            });

            // FORM INPUT (Always enabled)
            const formInput = document.getElementById('form-tour-input');
            const formDropdown = document.getElementById('form-tour-dropdown');

            formInput.addEventListener('focus', () => {
                renderDropdown(formInput.value, formDropdown, true);
                formDropdown.classList.remove('hidden');
            });

            formInput.addEventListener('input', (e) => {
                renderDropdown(e.target.value, formDropdown, true);
                formDropdown.classList.remove('hidden');
            });
            formInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addFormTour(formInput.value);
                }
            });


            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.add('hidden');
                }
                if (!formInput.contains(e.target) && !formDropdown.contains(e.target)) {
                    formDropdown.classList.add('hidden');
                }
            });
        }

        function renderDropdown(filterText = '', dropdownEl, isForm) {
            dropdownEl.innerHTML = '';

            const uniqueTours = new Set();
            state.paquetes.forEach(p => { if (p.tour) uniqueTours.add(p.tour); });

            const filtered = Array.from(uniqueTours).filter(t =>
                t.toLowerCase().includes(filterText.toLowerCase())
            );

            if (filtered.length === 0 && filterText.trim() !== '') {
                const action = isForm ? `addFormTour('${filterText}')` : `addTour('${filterText}')`;
                dropdownEl.innerHTML = `<div class="px-4 py-2 text-xs text-indigo-400 italic cursor-pointer hover:bg-slate-800" onclick="${action}">
                    <i class="fas fa-plus-circle mr-1"></i> Agregar "${filterText}"
                </div>`;
            }

            filtered.forEach(tour => {
                const opt = document.createElement('div');
                opt.className = 'px-4 py-2 text-sm text-slate-300 hover:bg-slate-700 cursor-pointer transition';
                opt.innerText = tour;
                opt.onclick = () => {
                    if (isForm) addFormTour(tour);
                    else addTour(tour);
                    dropdownEl.classList.add('hidden');
                };
                dropdownEl.appendChild(opt);
            });
        }

        // --- MODAL LOGIC ---
        function openContactModal(id) {
            const c = state.contactos.find(x => x.ID === id);
            if (!c) return;

            // Reset Edit Mode
            disableEditMode();

            // Populate Fields (Inputs)
            document.getElementById('modal-id').innerText = c.ID;
            document.getElementById('modal-nombre').value = c.Nombre || '';

            const rawWsp = (c.Numero_whatsapp || '').replace("'", "");
            document.getElementById('modal-whatsapp').value = rawWsp;
            document.getElementById('modal-btn-wsp').href = `https://wa.me/${rawWsp.replace('+', '')}`;

            // City Select
            document.getElementById('modal-ciudad').value = c.Ciudad_contacto || 'Otro'; // Default to Otro if not found

            // Tour Multi-Select Populating
            currentTours = [];
            if (c.Tour_interes && typeof c.Tour_interes === 'string') {
                // Split by comma, trim whitespace, filter empty
                c.Tour_interes.split(',').forEach(t => {
                    const trimmed = t.trim();
                    if (trimmed) currentTours.push(trimmed);
                });
            } else if (c.Tour_interes) {
                // Fallback for non-string values (e.g. number from CSV sometimes)
                currentTours.push(String(c.Tour_interes));
            }
            renderTours();

            // Status Select
            let st = (c.Estado_contacto || 'Lead');
            // Compatibility Mapping
            const map = {
                'lead': 'Lead',
                'nuevo': 'Lead',
                'contactado': 'Lead',
                'cotizacion': 'Info_enviada',
                'interesado': 'Info_enviada',
                'reserva': 'Reserva',
                'reserva confirmada': 'Reserva',
                'turista': 'Turista',
                'confirmada': 'Reserva'
            };
            if (map[st.toLowerCase()]) st = map[st.toLowerCase()];

            const statusSel = document.getElementById('modal-estado');
            // Fallback if value doesn't exist in options (e.g. unknown status)
            statusSel.value = st;
            if (!statusSel.value) statusSel.value = 'Lead';

            document.getElementById('modal-dni').value = c.DNI || '';
            document.getElementById('modal-personas').value = c.PAX || '';
            document.getElementById('modal-inicio-tour').value = c.Fecha_inicio_tour ? c.Fecha_inicio_tour.split('T')[0] : '';

            // Restrict Date Picker to Today
            const todayISO = new Date().toISOString().split('T')[0];
            document.getElementById('modal-inicio-tour').setAttribute('min', todayISO);

            document.getElementById('modal-dias-tour').value = c.Duracion_dias_tour || '';
            document.getElementById('modal-embarque').value = c.Punto_embarque || '';
            document.getElementById('modal-monto').value = parseFloat(c.Monto_cotizado) || 0;
            document.getElementById('modal-fecha-contacto').innerText = c.Fecha_ultimo_contacto ? c.Fecha_ultimo_contacto.replace('T', ' ').split('.')[0] : '-';

            document.getElementById('modal-notas').value = c.Notas || '';

            document.getElementById('modal-origen').innerText = `Origen: ${c.Origen || 'Desconocido'}`;
            document.getElementById('modal-registro').innerText = `Registrado: ${c.Fecha_registro ? c.Fecha_registro.replace('T', ' ').split('.')[0] : '-'}`;

            // Show Modal
            const modal = document.getElementById('contact-modal');
            const backdrop = document.getElementById('modal-backdrop');
            const panel = document.getElementById('modal-panel');

            modal.classList.remove('hidden');
            requestAnimationFrame(() => {
                backdrop.classList.remove('opacity-0');
                panel.classList.remove('opacity-0', 'translate-y-4', 'scale-95');
            });
        }

        function closeContactModal() {
            const modal = document.getElementById('contact-modal');
            const backdrop = document.getElementById('modal-backdrop');
            const panel = document.getElementById('modal-panel');

            backdrop.classList.add('opacity-0');
            panel.classList.add('opacity-0', 'translate-y-4', 'scale-95');

            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        // --- EDIT MODE LOGIC ---
        function enableEditMode() {
            document.getElementById('modal-btns-view').classList.add('hidden'); // Hide View Buttons (Close, Edit, Contact)
            document.getElementById('modal-btns-edit').classList.remove('hidden'); // Show Edit Buttons (Cancel, Save)

            const inputs = ['modal-nombre', 'modal-whatsapp', 'modal-ciudad', 'tour-input', 'modal-estado', 'modal-dni', 'modal-embarque', 'modal-monto', 'modal-notas', 'modal-personas', 'modal-dias-tour', 'modal-inicio-tour'];
            inputs.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.disabled = false;
                    if (el.tagName === 'INPUT') el.classList.remove('border-none', 'bg-transparent');
                    el.classList.add('bg-slate-800', 'border', 'border-slate-600');
                }
            });
        }

        function disableEditMode() {
            document.getElementById('modal-btns-view').classList.remove('hidden'); // Show View Buttons
            document.getElementById('modal-btns-edit').classList.add('hidden'); // Hide Edit Buttons

            const inputs = ['modal-nombre', 'modal-whatsapp', 'modal-ciudad', 'tour-input', 'modal-estado', 'modal-dni', 'modal-embarque', 'modal-monto', 'modal-notas', 'modal-personas', 'modal-dias-tour', 'modal-inicio-tour'];
            inputs.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.disabled = true;
                    if (el.tagName === 'INPUT') el.classList.add('border-none', 'bg-transparent');
                    el.classList.remove('bg-slate-800', 'border', 'border-slate-600');
                }
            });
        }

        async function saveContactChanges() {
            const idAttr = document.getElementById('modal-id').innerText;
            const id = idAttr ? idAttr.trim() : '';

            // Validar ID
            if (!id) {
                showToast('Error: No se encuentra el ID del contacto', 'warning');
                return;
            }

            const contact = state.contactos.find(x => x.ID === id);
            if (!contact) {
                showToast('Error: Contacto no encontrado en memoria', 'error');
                return;
            }

            // Collect Data
            const updated = {
                ...contact,
                Nombre: document.getElementById('modal-nombre').value,
                Numero_whatsapp: document.getElementById('modal-whatsapp').value,
                Ciudad_contacto: document.getElementById('modal-ciudad').value,
                Tour_interes: currentTours.join(', '),
                Estado_contacto: document.getElementById('modal-estado').value,
                DNI: document.getElementById('modal-dni').value,
                Punto_embarque: document.getElementById('modal-embarque').value,
                Monto_cotizado: document.getElementById('modal-monto').value,
                Notas: document.getElementById('modal-notas').value,
                PAX: document.getElementById('modal-personas').value,
                Fecha_inicio_tour: document.getElementById('modal-inicio-tour').value,
                Duracion_dias_tour: document.getElementById('modal-dias-tour').value,
                Fecha_ultimo_contacto: new Date().toLocaleString('sv-SE', { timeZone: 'America/Lima' }).replace(' ', 'T')
            };

            // 1. Update Local State
            const idx = state.contactos.findIndex(x => x.ID === id);
            state.contactos[idx] = updated;

            try {
                // 2. Update UI
                disableEditMode();
                closeContactModal();
                updateDashboard();
            } catch (uiError) {
                console.error("UI Update Error", uiError);
                showToast('Error visual (datos guardados)', 'warning');
            }

            // 3. Send to Webhook (Fire and forget from user perspective)
            const btn = document.querySelector('#modal-btns-edit button:last-child');
            const originalText = btn ? btn.innerHTML : 'Guardar';
            if (btn) btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';

            try {
                const payload = {
                    ID: updated.ID,
                    Nombre: updated.Nombre,
                    Numero_whatsapp: "'" + updated.Numero_whatsapp, // Force text in Sheets (Fix for + becoming formula)
                    Ciudad_contacto: updated.Ciudad_contacto,
                    Tour_interes: updated.Tour_interes,
                    Estado_contacto: updated.Estado_contacto,
                    DNI: updated.DNI,
                    Punto_embarque: updated.Punto_embarque,
                    Monto_cotizado: updated.Monto_cotizado,
                    Notas: updated.Notas,
                    PAX: updated.PAX,
                    Fecha_inicio_tour: updated.Fecha_inicio_tour,
                    Duracion_dias_tour: updated.Duracion_dias_tour,
                    Fecha_registro: updated.Fecha_registro, // <--- Added this to preserve it
                    Fecha_ultimo_contacto: updated.Fecha_ultimo_contacto,
                    Origen: updated.Origen,
                    Fecha_registro: updated.Fecha_registro,
                    Fecha_ultimo_contacto: updated.Fecha_ultimo_contacto,
                    Origen: updated.Origen,
                    Action: "UPDATE"
                };

                // Send to n8n (CORS enabled on server now)
                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    showToast('Cambios guardados exitosamente', 'success');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    showToast('Error al guardar', 'error');
                }

            } catch (e) {
                console.error(e);
                showToast('Cambios guardados localmente (Offline)', 'warning');
            } finally {
                if (btn) btn.innerHTML = originalText;
            }
        }

        // --- STATE ---


        // ... (Charts instance, initUI, etc remain same)

        // --- FILTER & PAGINATION ---
        function applyFilters() {
            const search = document.getElementById('table-search').value.toLowerCase();
            const fStatus = document.getElementById('filter-status').value.toLowerCase();
            const fCity = document.getElementById('filter-city').value.toLowerCase();

            // Filter Logic
            state.filteredContactos = state.contactos.filter(c => {
                // 1. Text Search (Name, Wsp, Notes, ID)
                const textMatch = [c.Nombre, c.Numero_whatsapp, c.Notas, c.ID]
                    .join(' ').toLowerCase().includes(search);
                // 2. Status Match
                const statusMatch = !fStatus || (c.Estado_contacto || '').toLowerCase().includes(fStatus);
                // 3. City Match
                const cityMatch = !fCity || (c.Ciudad_contacto || '').toLowerCase() === fCity;

                return textMatch && statusMatch && cityMatch;
            }).sort((a, b) => {
                // Default Sort: Newest First (Desc ID)
                const idA = parseInt((a.ID || '0').replace(/\D/g, ''));
                const idB = parseInt((b.ID || '0').replace(/\D/g, ''));
                return idB - idA;
            });

            // Reset to Page 1 on filter change
            state.currentPage = 1;
            renderTablePage();
        }

        function changePage(delta) {
            const maxPage = Math.ceil(state.filteredContactos.length / state.rowsPerPage);
            const newPage = state.currentPage + delta;

            if (newPage >= 1 && newPage <= maxPage) {
                state.currentPage = newPage;
                renderTablePage();
            }
        }

        function goToPage(target) {
            const maxPage = Math.ceil(state.filteredContactos.length / state.rowsPerPage);
            if (target === 'last') {
                state.currentPage = maxPage;
            } else {
                state.currentPage = 1;
            }
            renderTablePage();
        }

        function renderTablePage() {
            const tbody = document.getElementById('full-table-body');
            tbody.innerHTML = '';

            const total = state.filteredContactos.length;

            if (total === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="p-8 text-center text-slate-500">No se encontraron resultados</td></tr>`;
                document.getElementById('page-info-start').innerText = 0;
                document.getElementById('page-info-end').innerText = 0;
                document.getElementById('page-info-total').innerText = 0;
                document.getElementById('btn-prev').disabled = true;
                document.getElementById('btn-next').disabled = true;
                return;
            }

            // Slice Data
            const start = (state.currentPage - 1) * state.rowsPerPage;
            const end = Math.min(start + state.rowsPerPage, total);
            const pageData = state.filteredContactos.slice(start, end);

            // Render Rows
            pageData.forEach(c => {
                let statusColor = 'bg-slate-700 text-slate-300';
                const st = (c.Estado_contacto || '').toLowerCase();

                if (st.includes('reserva')) statusColor = 'bg-emerald-500/20 text-emerald-400 border border-emerald-500/20'; // Green
                else if (st.includes('turista')) statusColor = 'bg-cyan-500/20 text-cyan-400 border border-cyan-500/20'; // Cyan
                else if (st.includes('info_enviada')) statusColor = 'bg-amber-500/20 text-amber-400 border border-amber-500/20'; // Orange
                else if (st.includes('lead')) statusColor = 'bg-purple-500/20 text-purple-400 border border-purple-500/20'; // Purple
                else if (st.includes('cancelado')) statusColor = 'bg-rose-500/20 text-rose-400 border border-rose-500/20'; // Red

                const id = c.ID || '-';
                const name = c.Nombre || 'Sin Nombre';
                const wsp = c.Numero_whatsapp ? c.Numero_whatsapp.replace("'", "") : '-';
                const city = c.Ciudad_contacto || '-';
                const tour = c.Tour_interes || '-';
                const status = c.Estado_contacto || 'Nuevo';
                const amount = c.Monto_cotizado ? `S/ ${parseFloat(c.Monto_cotizado).toFixed(2)}` : '-';

                // Responsive Card (Mobile) / Table Row (Desktop)
                tbody.innerHTML += `
                    <tr class="block md:table-row mb-4 md:mb-0 bg-slate-900/80 md:bg-transparent rounded-xl md:rounded-none border border-slate-800 md:border-b md:border-x-0 group cursor-pointer hover:bg-slate-800 transition" onclick="openContactModal('${id}')">
                        
                        <!-- ID -->
                        <td class="block md:table-cell p-3 md:p-4 text-slate-500 font-mono text-xs border-b border-slate-800/50 md:border-none flex justify-between items-center bg-slate-950/30 md:bg-transparent rounded-t-xl md:rounded-none">
                            <span class="md:hidden font-bold uppercase tracking-wider text-[10px] text-slate-600">ID</span>
                            <span>${id}</span>
                        </td>

                        <!-- Nombre: Main Info on Mobile -->
                        <td class="block md:table-cell p-3 md:p-4 text-white font-bold border-b border-slate-800/50 md:border-none flex justify-between items-center">
                            <span class="md:hidden font-bold uppercase tracking-wider text-[10px] text-slate-600">Nombre</span>
                            <span class="text-lg md:text-sm text-indigo-400 md:text-white">${name}</span>
                        </td>

                        <!-- WhatsApp -->
                        <td class="block md:table-cell p-3 md:p-4 text-slate-400 font-mono text-xs border-b border-slate-800/50 md:border-none flex justify-between items-center">
                            <span class="md:hidden font-bold uppercase tracking-wider text-[10px] text-slate-600">WhatsApp</span>
                            <span>${wsp}</span>
                        </td>

                        <!-- Ciudad -->
                        <td class="block md:table-cell p-3 md:p-4 text-slate-300 text-xs uppercase border-b border-slate-800/50 md:border-none flex justify-between items-center">
                            <span class="md:hidden font-bold uppercase tracking-wider text-[10px] text-slate-600">Ciudad</span>
                            <span>${city}</span>
                        </td>

                        <!-- Tour -->
                        <td class="block md:table-cell p-3 md:p-4 text-slate-400 text-xs md:truncate md:max-w-[150px] border-b border-slate-800/50 md:border-none flex justify-between items-center">
                            <span class="md:hidden font-bold uppercase tracking-wider text-[10px] text-slate-600">Tour</span>
                            <span class="text-right">${tour}</span>
                        </td>

                        <!-- Estado -->
                        <td class="block md:table-cell p-3 md:p-4 text-center border-b border-slate-800/50 md:border-none flex justify-between items-center">
                            <span class="md:hidden font-bold uppercase tracking-wider text-[10px] text-slate-600">Estado</span>
                            <span class="inline-flex items-center px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wider ${statusColor}">
                                ${status}
                            </span>
                        </td>

                        <!-- Monto -->
                        <td class="block md:table-cell p-3 md:p-4 text-right font-bold text-emerald-500 border-none md:border-none flex justify-between items-center rounded-b-xl md:rounded-none">
                            <span class="md:hidden font-bold uppercase tracking-wider text-[10px] text-slate-600">Cotización</span>
                            <span>${amount}</span>
                        </td>
                    </tr>
                `;
            });

            // Update Controls
            document.getElementById('page-info-start').innerText = start + 1;
            document.getElementById('page-info-end').innerText = end;
            document.getElementById('page-info-total').innerText = total;

            const maxPage = Math.ceil(total / state.rowsPerPage);
            document.getElementById('btn-prev').disabled = state.currentPage === 1;
            document.getElementById('btn-next').disabled = state.currentPage === maxPage;

            // New Buttons Logic
            document.getElementById('btn-first').disabled = state.currentPage === 1;
            document.getElementById('btn-last').disabled = state.currentPage === maxPage;
        }

        // --- FORM SUBMISSION ---
        async function submitForm(e) {
            e.preventDefault();
            const form = e.target; // Get form element properly
            const loading = document.getElementById('form-loading');

            // Collect Data
            // Collect Data
            const formData = new FormData(form);

            // Format Name: Title Case
            let rawName = (formData.get('nombre') || '').trim();
            const nombre = rawName.toLowerCase().replace(/\b\w/g, s => s.toUpperCase());

            // Format WhatsApp: Remove spaces, Ensure '+' prefix
            let rawWsp = (formData.get('whatsapp') || '').replace(/\s+/g, '');
            let whatsapp = rawWsp;
            if (whatsapp && !whatsapp.startsWith('+')) {
                whatsapp = '+' + whatsapp;
            }

            // Validate Amount: Non-negative
            let monto = parseFloat(formData.get('monto')) || 0;
            const montoStr = monto.toFixed(2);

            // 1. Validation: Check Duplicates (Compare stripped numbers)
            // We strip non-digits to compare safely against potential variations in Sheet
            const cleanNewWsp = whatsapp.replace(/\D/g, '');
            const duplicate = state.contactos.find(c => {
                const cleanExisting = (c.Numero_whatsapp || '').replace(/\D/g, '');
                return cleanExisting === cleanNewWsp && cleanExisting.length > 5; // Ensure not empty/short matches
            });

            if (duplicate) {
                showToast(`El número ${whatsapp} ya está registrado`, 'error');
                return;
            }

            // 2. Logic: Auto-ID
            let newId = 'C-000001';
            if (state.contactos.length > 0) {
                const ids = state.contactos.map(c => c.ID).filter(id => id && id.startsWith('C-'));
                if (ids.length > 0) {
                    const maxNum = Math.max(...ids.map(id => parseInt(id.split('-')[1]) || 0));
                    newId = `C-${(maxNum + 1).toString().padStart(6, '0')}`;
                }
            }

            // Date in Peru Timezone (Format: YYYY-MM-DD HH:mm:ss)
            const now = new Date().toLocaleString('sv-SE', {
                timeZone: 'America/Lima',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            }).replace(' ', 'T'); // Results in "2026-01-07T17:00:00" (Local Peru Time)

            // Ensure we use the 'whatsapp' variable which surely has '+'
            const jsonData = {
                ID: newId,
                Nombre: nombre,
                Numero_whatsapp: "'" + whatsapp, // Force text in Sheets
                DNI: (formData.get('dni') || '').trim(),
                Ciudad_contacto: formData.get('ciudad'),
                Tour_interes: formTours.join(', '),
                Estado_contacto: formData.get('estado'),
                Punto_embarque: (formData.get('punto_embarque') || '').trim(),
                Fecha_registro: now,
                Fecha_ultimo_contacto: now,
                PAX: (formData.get('numero_personas') || '').trim(),
                Fecha_inicio_tour: (formData.get('fecha_inicio_tour') || ''),
                Duracion_dias_tour: (formData.get('duracion_dias_tour') || ''),
                Monto_cotizado: montoStr,
                Notas: (formData.get('notas') || '').trim(),
                Origen: 'web_dashboard',
                Action: 'CREATE'
            };

            // Basic Validation
            if (!jsonData.Nombre || !jsonData.Numero_whatsapp) return showToast("Faltan datos requeridos", "error");

            loading.classList.remove('hidden');

            try {
                // Post to Webhook
                const res = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(jsonData)
                });

                if (res.ok) {
                    showToast("✅ Contacto enviado al CRM");
                    form.reset();

                    // Optimistic UI Update (Add to local state immediately)
                    state.contactos.push({
                        ID: jsonData.ID,
                        Nombre: jsonData.Nombre,
                        Numero_whatsapp: jsonData.Numero_whatsapp.replace("'", ""), // Remove quote for UI display
                        Ciudad_contacto: jsonData.Ciudad_contacto,
                        Tour_interes: jsonData.Tour_interes,
                        Fecha_registro: jsonData.Fecha_registro.replace('T', ' ').split('.')[0], // Format approx
                        Monto_cotizado: jsonData.Monto_cotizado
                    });

                    // Reset Form Extras
                    formTours = [];
                    renderFormTours();

                    updateDashboard();

                } else {
                    throw new Error("Webhook Error");
                }
            } catch (err) {
                console.error(err);
                showToast("⚠️ Hubo un error al enviar (Posible CORS/Network)", "error");
            } finally {
                loading.classList.add('hidden');
            }
        }

        // --- EXPORT LOGIC ---
        function openExportModal() {
            const modal = document.getElementById('export-modal');
            modal.classList.remove('hidden');
            requestAnimationFrame(() => {
                document.getElementById('export-backdrop').classList.remove('opacity-0');
                document.getElementById('export-panel').classList.remove('opacity-0', 'scale-95', 'translate-y-4');
            });
        }

        function closeExportModal() {
            const backdrop = document.getElementById('export-backdrop');
            const panel = document.getElementById('export-panel');
            backdrop.classList.add('opacity-0');
            panel.classList.add('opacity-0', 'scale-95', 'translate-y-4');
            setTimeout(() => document.getElementById('export-modal').classList.add('hidden'), 300);
        }

        function downloadExport(type) {
            let data = [...state.contactos]; // Copy array
            let filename = 'contactos_todo.csv';

            if (type === 'month') {
                const val = document.getElementById('export-month').value; // YYYY-MM
                if (!val) { showToast('Selecciona un mes', 'warning'); return; }
                data = data.filter(c => c.Fecha_registro && c.Fecha_registro.startsWith(val));
                filename = `contactos_mes_${val}.csv`;
            } else if (type === 'day') {
                const val = document.getElementById('export-day').value; // YYYY-MM-DD
                if (!val) { showToast('Selecciona un día', 'warning'); return; }
                data = data.filter(c => c.Fecha_registro && c.Fecha_registro.startsWith(val));
                filename = `contactos_dia_${val}.csv`;
            }

            if (data.length === 0) { showToast('No hay datos para esa fecha', 'warning'); return; }

            // Unparse
            const csv = Papa.unparse(data);
            // Add BOM (\uFEFF) so Excel recognizes it as UTF-8
            const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showToast(`Descargados ${data.length} registros`, 'success');
            closeExportModal();
        }

        // --- MOBILE SIDEBAR TOGGLE ---
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');

            // Toggle Translate Class
            sidebar.classList.toggle('-translate-x-full');

            // Toggle Overlay
            if (overlay.classList.contains('hidden')) {
                overlay.classList.remove('hidden');
                // Small delay to allow transition
                requestAnimationFrame(() => overlay.classList.remove('opacity-0'));
            } else {
                overlay.classList.add('opacity-0');
                setTimeout(() => overlay.classList.add('hidden'), 300);
            }
        }

        // --- NAVIGATION & UTILS ---
        function switchView(viewName) {
            const views = ['overview', 'leads', 'form'];
            views.forEach(v => {
                document.getElementById('view-' + v).classList.add('hidden');
                document.getElementById('nav-' + v).classList.remove('active', 'bg-indigo-500/10', 'text-indigo-400', 'border-indigo-500', 'border-r-3');
                // Reset basic style
                document.getElementById('nav-' + v).classList.add('text-slate-400');
            });

            const activeNav = document.getElementById('nav-' + viewName);
            activeNav.classList.add('active', 'text-indigo-400');
            activeNav.classList.remove('text-slate-400');

            document.getElementById('view-' + viewName).classList.remove('hidden');
            document.getElementById('page-title').innerText = viewName === 'overview' ? 'Dashboard' : (viewName === 'form' ? 'Nuevo Contacto' : 'Base de Datos');

            // Toggle Global Filter            // GLOBAL FILTER VISIBILITY (FIXED)
            const globalFilter = document.getElementById('global-date-filter');
            if (globalFilter) {
                if (viewName === 'overview') {
                    globalFilter.classList.remove('hidden');
                    globalFilter.classList.add('md:flex'); // Restore flex layout
                } else {
                    globalFilter.classList.add('hidden');
                    globalFilter.classList.remove('md:flex'); // Remove flex layout
                }
            }

            // Auto-close sidebar on mobile
            const overlay = document.getElementById('sidebar-overlay');
            // Check actual visibility or screen width to be safe
            if (window.innerWidth < 1024 && !overlay.classList.contains('hidden')) {
                toggleSidebar();
            }
        }

        function showToast(msg, type = 'success') {
            const container = document.getElementById('toast-container');
            const el = document.createElement('div');
            const color = type === 'success' ? 'bg-emerald-500' : 'bg-rose-500';
            el.className = `${color} text-white px-6 py-3 rounded-xl shadow-2xl font-bold text-sm flex items-center gap-3 transform translate-y-10 opacity-0 transition-all duration-300 pointer-events-auto`;
            el.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check' : 'fa-exclamation-triangle'}"></i> <span>${msg}</span>`;

            container.appendChild(el);

            // Animation In
            requestAnimationFrame(() => { el.classList.remove('translate-y-10', 'opacity-0'); });

            // Remove after 3s
            setTimeout(() => {
                el.classList.add('translate-y-10', 'opacity-0');
                setTimeout(() => el.remove(), 300);
            }, 3000);
        }

        // --- FORECAST CHART LOGIC (INLINED) ---
        function renderForecastChart() {
            // SECURITY: Ensure 'charts' variable is accessible.
            let chartRegistry;
            if (typeof charts !== 'undefined') {
                chartRegistry = charts;
            } else if (window.charts) {
                chartRegistry = window.charts;
            } else {
                console.error("Critical: 'charts' object not found in global scope.");
                return;
            }

            const ctxWrapper = document.getElementById('chart-forecast');
            if (!ctxWrapper) return;

            if (chartRegistry.forecast) chartRegistry.forecast.destroy();

            const ctx = ctxWrapper.getContext('2d');

            // --- 1. Generar Ventana de 7 Días ---
            const labels = [];
            const dates = [];
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Inicio del día

            // Rango: HOY hasta HOY+4 (5 días)
            for (let i = 0; i < 5; i++) {
                const d = new Date(today);
                d.setDate(today.getDate() + i);
                dates.push(d);

                const dow = d.toLocaleDateString('es-ES', { weekday: 'short' });
                const dayNum = d.getDate();
                labels.push(`${dow} ${dayNum}`);
            }

            // --- 2. Color Generator (Dynamic Hash) ---
            const getTourColor = (tourName) => {
                if (!tourName) return '#94a3b8'; // Slate default

                let hash = 0;
                for (let i = 0; i < tourName.length; i++) {
                    hash = tourName.charCodeAt(i) + ((hash << 5) - hash);
                }

                const h = Math.abs(hash % 360);
                return `hsl(${h}, 70%, 55%)`;
            };

            const datasets = [];

            // Validar estado
            let globalState;
            if (typeof state !== 'undefined') globalState = state;
            else if (window.state) globalState = window.state;
            else return;

            if (!globalState || !globalState.contactos) return;

            globalState.contactos.forEach(c => {
                // Filtro Básico
                if (c.Estado_contacto === 'Cancelado' || !c.Fecha_inicio_tour) return;

                // Parsear Fechas (YYYY-MM-DD)
                const startParts = c.Fecha_inicio_tour.split('-');
                if (startParts.length !== 3) return;

                const startDate = new Date(startParts[0], startParts[1] - 1, startParts[2]);
                const duration = parseInt(c.Duracion_dias_tour) || 1;

                const endDate = new Date(startDate);
                endDate.setDate(endDate.getDate() + duration);

                // Ventana del forecast
                const windowStart = dates[0];
                const windowEnd = new Date(dates[4]);
                windowEnd.setDate(windowEnd.getDate() + 1);

                // Verificar solapamiento
                if (endDate <= windowStart || startDate >= windowEnd) return;

                // Generar Array de Datos (7 días)
                let hasActivity = false;
                const paxData = dates.map(date => {
                    const dTime = date.getTime();
                    const sTime = startDate.getTime();
                    const eTime = endDate.getTime();

                    if (dTime >= sTime && dTime < eTime) {
                        hasActivity = true;
                        return parseInt(c.PAX) || 1;
                    }
                    return 0;
                });

                if (!hasActivity) return;

                // Determinar Color y Label
                const tourName = c.Tour_interes || 'General';
                const color = getTourColor(tourName);

                // Crear Dataset Individual
                datasets.push({
                    label: tourName,
                    data: paxData,
                    backgroundColor: color,
                    hoverBackgroundColor: color.replace('55%)', '65%)'),
                    borderRadius: 4,
                    stack: 'stack1',
                    barPercentage: 0.6,
                    guestName: c.Nombre,
                    guestWsp: c.Numero_whatsapp,
                    guestPax: parseInt(c.PAX) || 1
                });
            });

            // --- 3. Renderizar Gráfico ---
            chartRegistry.forecast = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            align: 'start',
                            labels: {
                                color: '#cbd5e1',
                                font: { size: 10 },
                                boxWidth: 10,
                                usePointStyle: true,
                                filter: function (item, chartData) {
                                    const label = item.text;
                                    const firstIndex = chartData.datasets.findIndex(ds => ds.label === label);
                                    return item.datasetIndex === firstIndex;
                                }
                            }
                        },
                        tooltip: {
                            mode: 'nearest',
                            intersect: true,
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            titleColor: '#f1f5f9',
                            bodyColor: '#cbd5e1',
                            borderColor: '#334155',
                            borderWidth: 1,
                            callbacks: {
                                title: (items) => {
                                    if (items.length > 0) {
                                        return items[0].dataset.guestName;
                                    }
                                    return '';
                                },
                                label: (context) => {
                                    const ds = context.dataset;
                                    return ` ${ds.label} (PAX: ${ds.guestPax})`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            grid: { color: '#334155' },
                            ticks: { stepSize: 1, precision: 0, color: '#94a3b8' },
                            title: { display: true, text: 'PAX', color: '#64748b' }
                        },
                        x: {
                            stacked: true,
                            grid: { display: false },
                            ticks: { color: '#94a3b8', font: { size: 11 } }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: true
                    }
                }
            });

            console.log(`Forecast Rendered: ${datasets.length} active tourists.`);
        }

        // --- EXPORT TO EXCEL FEATURE ---
        function exportDailyReport() {
            if (!state.contactos || state.contactos.length === 0) {
                showToast("No hay datos para exportar", "error");
                return;
            }

            // Get local date string YYYY-MM-DD to filter "Today's" Records
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const todayStr = `${year}-${month}-${day}`;

            console.log("Exporting for date:", todayStr);

            // Filter contacts registered TODAY
            const dailyContacts = state.contactos.filter(c => {
                if (!c.Fecha_registro) return false;
                // Check if starts with today's date (YYYY-MM-DD...)
                return c.Fecha_registro.startsWith(todayStr);
            });

            if (dailyContacts.length === 0) {
                showToast(`No hay ventas/registros con fecha ${todayStr}`, "warning");
                return;
            }

            // Prepare Data columns
            const exportData = dailyContacts.map(c => ({
                ID: c.ID,
                Nombre: c.Nombre,
                Celular: c.Numero_whatsapp,
                Ciudad: c.Ciudad_contacto,
                Tours: c.Tour_interes,
                PAX: c.PAX,
                Monto: c.Monto_cotizado,
                Estado: c.Estado_contacto,
                Fecha: c.Fecha_registro,
                Notas: c.Notas
            }));

            // Create Worksheet
            const ws = XLSX.utils.json_to_sheet(exportData);

            // Adjust Column Widths
            const wscols = [
                { wch: 10 }, // ID
                { wch: 25 }, // Nombre
                { wch: 15 }, // Celular
                { wch: 15 }, // Ciudad
                { wch: 30 }, // Tours
                { wch: 5 },  // PAX
                { wch: 10 }, // Monto
                { wch: 15 }, // Estado
                { wch: 20 }, // Fecha
                { wch: 30 }  // Notas
            ];
            ws['!cols'] = wscols;

            // Create Workbook
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Reporte Diario");

            // Export File
            const fileName = `Reporte_Ventas_${todayStr}.xlsx`;
            XLSX.writeFile(wb, fileName);

            showToast(`Reporte descargado: ${fileName}`, "success");
        }
    </script>
</body>

</html>