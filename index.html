<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | 20 Enero</title>
    <meta name="description" content="Dashboard de GestiÃ³n para Agencia de Turismo">

    <!-- Poppins Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- SheetJS (XLSX) -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Poppins', 'sans-serif'] },
                    colors: { primary: "#059669", secondary: "#0f172a" }
                }
            }
        }
    </script>
    <style>
        .modal-overlay {
            background-color: rgba(15, 23, 42, 0.75);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            max-height: 90vh;
            overflow-y: auto;
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-900 antialiased h-screen flex overflow-hidden">

    <!-- Mobile Sidebar Overlay -->
    <div id="sidebar-overlay" onclick="toggleSidebar()"
        class="fixed inset-0 bg-slate-900/50 z-40 hidden md:hidden backdrop-blur-sm transition-opacity"></div>

    <!-- Sidebar -->
    <aside id="sidebar-menu"
        class="w-64 bg-slate-900 text-white flex flex-col fixed inset-y-0 left-0 z-50 transition-transform duration-300 -translate-x-full md:translate-x-0 md:static md:flex h-full shadow-2xl md:shadow-none">
        <div class="p-6 border-b border-slate-800">
            <h1 class="text-2xl font-bold">Agencia<span class="text-emerald-500">.</span></h1>
        </div>
        <nav class="flex-1 p-4 space-y-2">
            <button onclick="switchView('dashboard')" id="nav-dashboard"
                class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-slate-800 text-slate-300 hover:text-white font-medium">
                ðŸ“Š Dashboard
            </button>
            <button onclick="switchView('contacts')" id="nav-contacts"
                class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-slate-800 text-slate-300 hover:text-white font-medium">
                ðŸ‘¥ Contactos
            </button>
            <button onclick="switchView('reservations')" id="nav-reservations"
                class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-slate-800 text-slate-300 hover:text-white font-medium">
                ðŸ“… Reservas
            </button>
            <button onclick="switchView('payments')" id="nav-payments"
                class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-slate-800 text-slate-300 hover:text-white font-medium">
                ðŸ’° Caja
            </button>
            <button onclick="switchView('tours')" id="nav-tours"
                class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-slate-800 text-slate-300 hover:text-white font-medium">
                ðŸ§­ Tours
            </button>
        </nav>
        <div class="p-4">
            <div class="bg-gradient-to-tr from-emerald-600 to-teal-500 rounded-xl p-4">
                <p class="text-xs text-emerald-100 mb-1">Usuario Actual</p>
                <p class="font-semibold text-sm">Admin Agencia</p>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <!-- Main Content -->
    <main class="flex-1 flex flex-col min-w-0 bg-slate-50 overflow-hidden relative">
        <!-- Mobile Header -->
        <div
            class="md:hidden bg-white border-b border-slate-200 px-4 py-3 flex items-center justify-between shrink-0 z-30">
            <div class="font-bold text-lg text-slate-800">Agencia<span class="text-emerald-500">.</span></div>
            <button onclick="toggleSidebar()"
                class="p-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16">
                    </path>
                </svg>
            </button>
        </div>

        <div class="flex-1 overflow-auto p-4 md:p-8 pb-32">

            <!-- DASHBOARD VIEW -->
            <!-- DASHBOARD VIEW -->
            <section id="view-dashboard" class="view-section space-y-6">
                <!-- Header with Filters -->
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <h2 class="text-2xl font-bold text-slate-800">Panel de Control</h2>
                    <div class="bg-white rounded-lg p-1 border border-slate-200 flex shadow-sm">
                        <button onclick="updateDashboardPeriod('month')" id="btn-period-month"
                            class="px-4 py-2 text-sm font-medium rounded-md transition-colors bg-blue-600 text-white">Este
                            Mes</button>
                        <button onclick="updateDashboardPeriod('quarter')" id="btn-period-quarter"
                            class="px-4 py-2 text-sm font-medium rounded-md text-slate-600 hover:bg-slate-50 transition-colors">Ãšltimo
                            Trimestre</button>
                    </div>
                </div>

                <!-- Metrics Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-slate-900 text-white p-6 rounded-2xl shadow-lg">
                        <p class="text-slate-400 text-xs font-semibold uppercase mb-1">Ingresos Estimados</p>
                        <h3 class="text-3xl font-bold" id="metric-revenue">S/ --</h3>
                    </div>
                    <div class="bg-slate-900 text-white p-6 rounded-2xl shadow-lg">
                        <p class="text-slate-400 text-xs font-semibold uppercase mb-1">Turistas / Oportunidad</p>
                        <h3 class="text-3xl font-bold" id="metric-conversion">-- / --</h3>
                    </div>
                    <div class="bg-slate-900 text-white p-6 rounded-2xl shadow-lg">
                        <p class="text-slate-400 text-xs font-semibold uppercase mb-1">Paquete Top</p>
                        <h3 class="text-xl font-bold truncate" id="metric-top-tour">--</h3>
                    </div>
                    <div class="bg-slate-900 text-white p-6 rounded-2xl shadow-lg">
                        <p class="text-slate-400 text-xs font-semibold uppercase mb-1">Origen Principal</p>
                        <h3 class="text-2xl font-bold" id="metric-top-origin">--</h3>
                    </div>
                </div>

                <!-- Charts Row 1: Forecast & Trend -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 lg:col-span-2">
                        <h3 class="text-lg font-bold text-slate-800 mb-4">PronÃ³stico Operativo</h3>
                        <div id="forecast-timeline"></div>
                    </div>
                </div>

                <!-- Charts Row 2: Trend & Distribution -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                        <h3 class="text-lg font-bold text-slate-800 mb-4">EvoluciÃ³n de Nuevos Contactos</h3>
                        <div class="h-64"><canvas id="chartPaxTrend"></canvas></div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                        <h3 class="text-lg font-bold text-slate-800 mb-4">DistribuciÃ³n por Ciudad</h3>
                        <div class="h-64"><canvas id="chartCities"></canvas></div>
                    </div>
                </div>

                <!-- Charts Row 3: Top Tours -->
                <div class="grid grid-cols-1 gap-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                        <h3 class="text-lg font-bold text-slate-800 mb-4">Top Tours por PAX</h3>
                        <div class="h-64"><canvas id="chartTopTours"></canvas></div>
                    </div>
                </div>
            </section>

            <!-- CONTACTS VIEW -->
            <section id="view-contacts" class="view-section hidden space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold">Base de Contactos</h2>
                    <div class="flex gap-2">
                        <button onclick="openExportModal('contacts')"
                            class="px-3 py-2 text-sm text-slate-600 bg-white border border-slate-200 rounded-lg hover:bg-slate-50 flex items-center gap-2">
                            <span>ðŸ“¥</span> Exportar
                        </button>
                        <button onclick="openContactModal()"
                            class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg text-sm font-medium">
                            + Nuevo Contacto
                        </button>
                    </div>
                </div>
                <div class="bg-white border border-slate-200 rounded-xl overflow-x-auto shadow-sm">
                    <table class="w-full text-left text-sm min-w-[800px]">
                        <thead
                            class="bg-slate-50 border-b border-slate-200 text-xs uppercase font-semibold text-slate-500">
                            <tr>
                                <th class="px-6 py-4">Nombre</th>
                                <th class="px-6 py-4">Whatsapp</th>
                                <th class="px-6 py-4">Ciudad</th>
                                <th class="px-6 py-4">Estado</th>
                                <th class="px-6 py-4">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="table-contacts-body"></tbody>
                    </table>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-xs text-slate-500" id="contacts-page-info">PÃ¡gina 1</span>
                    <div class="flex gap-1 flex-wrap justify-end">
                        <button onclick="changePage('contacts', 'first')" id="btn-first-contacts"
                            class="px-3 py-1 text-xs bg-white border rounded hover:bg-slate-50 disabled:opacity-50">Inicio</button>
                        <button onclick="changePage('contacts', -1)" id="btn-prev-contacts"
                            class="px-3 py-1 text-xs bg-white border rounded hover:bg-slate-50 disabled:opacity-50">Anterior</button>
                        <button onclick="changePage('contacts', 1)" id="btn-next-contacts"
                            class="px-3 py-1 text-xs bg-white border rounded hover:bg-slate-50 disabled:opacity-50">Siguiente</button>
                        <button onclick="changePage('contacts', 'last')" id="btn-last-contacts"
                            class="px-3 py-1 text-xs bg-white border rounded hover:bg-slate-50 disabled:opacity-50">Fin</button>
                    </div>
                </div>
            </section>

            <!-- RESERVATIONS VIEW -->
            <section id="view-reservations" class="view-section hidden space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold">Reservas</h2>
                    <div class="flex gap-2">
                        <button onclick="openExportModal('reservations')"
                            class="px-3 py-2 text-sm text-slate-600 bg-white border border-slate-200 rounded-lg hover:bg-slate-50 flex items-center gap-2">
                            <span>ðŸ“¥</span> Exportar
                        </button>
                        <button onclick="openReservationModal()"
                            class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg text-sm font-medium">
                            + Nueva Reserva
                        </button>
                    </div>
                </div>
                <div class="bg-white border border-slate-200 rounded-xl overflow-x-auto shadow-sm">
                    <table class="w-full text-left text-sm min-w-[800px]">
                        <thead
                            class="bg-slate-50 border-b border-slate-200 text-xs uppercase font-semibold text-slate-500">
                            <tr>
                                <th class="px-6 py-4">Cliente</th>
                                <th class="px-6 py-4">Tours</th>
                                <th class="px-6 py-4">Fecha del Tour</th>
                                <th class="px-6 py-4 text-right">Balance</th>
                                <th class="px-6 py-4">Estado</th>
                            </tr>
                        </thead>
                        <tbody id="table-reservations-body"></tbody>
                    </table>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-xs text-slate-500" id="reservations-page-info">PÃ¡gina 1</span>
                    <div class="flex gap-1 flex-wrap justify-end">
                        <button onclick="changePage('reservations', 'first')" id="btn-first-reservations"
                            class="px-3 py-1 text-xs bg-white border rounded hover:bg-slate-50 disabled:opacity-50">Inicio</button>
                        <button onclick="changePage('reservations', -1)" id="btn-prev-reservations"
                            class="px-3 py-1 text-xs bg-white border rounded hover:bg-slate-50 disabled:opacity-50">Anterior</button>
                        <button onclick="changePage('reservations', 1)" id="btn-next-reservations"
                            class="px-3 py-1 text-xs bg-white border rounded hover:bg-slate-50 disabled:opacity-50">Siguiente</button>
                        <button onclick="changePage('reservations', 'last')" id="btn-last-reservations"
                            class="px-3 py-1 text-xs bg-white border rounded hover:bg-slate-50 disabled:opacity-50">Fin</button>
                    </div>
                </div>
            </section>

            <!-- PAYMENTS VIEW -->
            <section id="view-payments" class="view-section hidden space-y-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-bold">Caja y Pagos</h2>
                        <p class="text-sm text-slate-500 mt-1">Vista de auditorÃ­a - Solo lectura</p>
                    </div>
                    <div>
                        <button onclick="openExportModal('payments')"
                            class="px-3 py-2 text-sm text-slate-600 bg-white border border-slate-200 rounded-lg hover:bg-slate-50 flex items-center gap-2">
                            <span>ðŸ“¥</span> Exportar
                        </button>
                    </div>
                </div>
                <div class="bg-white border border-slate-200 rounded-xl overflow-x-auto shadow-sm">
                    <table class="w-full text-left text-sm min-w-[600px]">
                        <thead
                            class="bg-slate-50 border-b border-slate-200 text-xs uppercase font-semibold text-slate-500">
                            <tr>
                                <th scope="col" class="px-6 py-3">Reserva (Cliente)</th>
                                <th scope="col" class="px-6 py-3">Tour</th>
                                <th scope="col" class="px-6 py-3 text-right">Monto</th>
                                <th scope="col" class="px-6 py-3">MÃ©todo</th>
                                <th scope="col" class="px-6 py-3">Notas</th>
                                <th scope="col" class="px-6 py-3">Fecha</th>
                            </tr>
                        </thead>
                        <tbody id="table-payments-body"></tbody>
                    </table>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-xs text-slate-500" id="payments-page-info">PÃ¡gina 1</span>
                    <div class="flex gap-1 flex-wrap justify-end">
                        <button onclick="changePage('payments', 'first')" id="btn-first-payments"
                            class="px-3 py-1 text-xs bg-white border rounded hover:bg-slate-50 disabled:opacity-50">Inicio</button>
                        <button onclick="changePage('payments', -1)" id="btn-prev-payments"
                            class="px-3 py-1 text-xs bg-white border rounded hover:bg-slate-50 disabled:opacity-50">Anterior</button>
                        <button onclick="changePage('payments', 1)" id="btn-next-payments"
                            class="px-3 py-1 text-xs bg-white border rounded hover:bg-slate-50 disabled:opacity-50">Siguiente</button>
                        <button onclick="changePage('payments', 'last')" id="btn-last-payments"
                            class="px-3 py-1 text-xs bg-white border rounded hover:bg-slate-50 disabled:opacity-50">Fin</button>
                    </div>
                </div>
            </section>

            <!-- TOURS VIEW -->
            <section id="view-tours" class="view-section hidden space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold">GestiÃ³n de Tours</h2>
                    <button onclick="openTourModal()"
                        class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg text-sm font-medium">
                        + Nuevo Tour
                    </button>
                </div>
                <div class="bg-white border border-slate-200 rounded-xl overflow-x-auto shadow-sm">
                    <table class="w-full text-left text-sm min-w-[700px]">
                        <thead
                            class="bg-slate-50 border-b border-slate-200 text-xs uppercase font-semibold text-slate-500">
                            <tr>
                                <th class="px-6 py-4">Nombre del Tour</th>
                                <th class="px-6 py-4">DuraciÃ³n</th>
                                <th class="px-6 py-4 text-right">Precio Ref.</th>
                                <th class="px-6 py-4">Estado</th>
                                <th class="px-6 py-4">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="table-tours-body"></tbody>
                    </table>
                </div>
            </section>

        </div>
    </main>

    <!-- MODALS -->

    <!-- Contact Modal -->
    <div id="modal-contact" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-overlay">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md modal-content">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-lg font-bold" id="contact-modal-title">Nuevo Contacto</h3>
                <button onclick="closeModal('contact')" class="text-slate-400 hover:text-slate-600">&times;</button>
            </div>
            <div class="p-6 space-y-4">
                <input type="hidden" id="inp-c-id">
                <div>
                    <label class="block text-sm font-medium mb-1">Nombre Completo</label>
                    <input type="text" id="inp-c-name" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Whatsapp</label>
                    <input type="text" id="inp-c-phone" class="w-full px-3 py-2 border rounded-lg" placeholder="+51...">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">DNI (Opcional)</label>
                    <input type="text" id="inp-c-dni" class="w-full px-3 py-2 border rounded-lg" placeholder="12345678">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Ciudad</label>
                        <select id="inp-c-city" class="w-full px-3 py-2 border rounded-lg">
                            <option value="Lima">Lima</option>
                            <option value="Huancayo">Huancayo</option>
                            <option value="Tingo MarÃ­a">Tingo MarÃ­a</option>
                            <option value="Arequipa">Arequipa</option>
                            <option value="Ayacucho">Ayacucho</option>
                            <option value="Cajamarca">Cajamarca</option>
                            <option value="Callao">Callao</option>
                            <option value="Chiclayo">Chiclayo</option>
                            <option value="Chimbote">Chimbote</option>
                            <option value="Cusco">Cusco</option>
                            <option value="Huacho">Huacho</option>
                            <option value="HuÃ¡nuco">HuÃ¡nuco</option>
                            <option value="Ica">Ica</option>
                            <option value="Iquitos">Iquitos</option>
                            <option value="Juliaca">Juliaca</option>
                            <option value="Piura">Piura</option>
                            <option value="Pucallpa">Pucallpa</option>
                            <option value="Tacna">Tacna</option>
                            <option value="Tarapoto">Tarapoto</option>
                            <option value="Trujillo">Trujillo</option>
                            <option value="Otro">Otro</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Fuente</label>
                        <select id="inp-c-source" class="w-full px-3 py-2 border rounded-lg">
                            <option value="Dashboard">Dashboard</option>
                            <option value="Web">Web</option>
                            <option value="Instagram">Instagram</option>
                            <option value="Facebook">Facebook</option>
                            <option value="Whatsapp">Whatsapp</option>
                            <option value="Referido">Referido</option>
                        </select>
                    </div>
                </div>
                <div class="hidden">
                    <label class="block text-sm font-medium mb-1">Estado</label>
                    <select id="inp-c-status" class="w-full px-3 py-2 border rounded-lg">
                        <option value="Lead">Lead</option>
                        <option value="Cliente">Cliente</option>
                    </select>
                </div>
            </div>
            <div class="p-6 border-t flex justify-end gap-3">
                <button onclick="closeModal('contact')" class="px-4 py-2 text-slate-600">Cancelar</button>
                <button onclick="saveContact()"
                    class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Tour Modal -->
    <div id="modal-tour" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-overlay">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md modal-content">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-lg font-bold" id="tour-modal-title">Nuevo Tour</h3>
                <button onclick="closeModal('tour')" class="text-slate-400 hover:text-slate-600">&times;</button>
            </div>
            <div class="p-6 space-y-4">
                <input type="hidden" id="inp-t-id">
                <div>
                    <label class="block text-sm font-medium mb-1">Nombre del Tour</label>
                    <input type="text" id="inp-t-name" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">DescripciÃ³n (Opcional)</label>
                    <input type="text" id="inp-t-desc" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Precio Referencial</label>
                        <input type="number" id="inp-t-price" class="w-full px-3 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">DuraciÃ³n</label>
                        <input type="text" id="inp-t-duration" class="w-full px-3 py-2 border rounded-lg"
                            placeholder="Ej: 5 Horas">
                    </div>
                </div>
            </div>
            <div class="p-6 border-t flex justify-end gap-3">
                <button onclick="closeModal('tour')" class="px-4 py-2 text-slate-600">Cancelar</button>
                <button onclick="saveTour()"
                    class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="modal-payment" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-overlay">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md modal-content">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-lg font-bold" id="payment-modal-title">Registrar Pago</h3>
                <button onclick="closeModal('payment')" class="text-slate-400 hover:text-slate-600">&times;</button>
            </div>
            <div class="p-6 space-y-4">
                <input type="hidden" id="inp-p-id">
                <input type="hidden" id="inp-p-reserva-id">

                <div>
                    <label class="block text-sm font-medium mb-1">Reserva (Cliente)</label>
                    <input type="text" id="inp-p-cliente" class="w-full px-3 py-2 border rounded-lg bg-slate-50"
                        readonly>
                </div>

                <!-- Reservation Info -->
                <div id="payment-reservation-info"
                    class="hidden bg-emerald-50 border border-emerald-200 rounded-lg p-4">
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <div>
                            <span class="text-slate-600">Monto Acordado:</span>
                            <span class="font-bold text-emerald-700" id="info-monto-total">S/ 0.00</span>
                        </div>
                        <div>
                            <span class="text-slate-600">Ya Pagado:</span>
                            <span class="font-bold" id="info-ya-pagado">S/ 0.00</span>
                        </div>
                        <div class="col-span-2 pt-2 border-t border-emerald-200">
                            <span class="text-slate-600">Saldo Pendiente:</span>
                            <span class="font-bold text-lg text-orange-600" id="info-saldo-pendiente">S/ 0.00</span>
                        </div>
                    </div>
                </div>
                <input type="hidden" id="inp-p-monto-total">
                <input type="hidden" id="inp-p-balance-actual">

                <div>
                    <label class="block text-sm font-medium mb-1">Monto (usar negativo para devoluciÃ³n)</label>
                    <input type="number" id="inp-p-monto" class="w-full px-3 py-2 border rounded-lg"
                        placeholder="100 o -50" step="0.01">
                    <p class="text-xs text-slate-500 mt-1">Ejemplo: 100 para pago, -50 para devoluciÃ³n</p>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-1">MÃ©todo de Pago</label>
                    <select id="inp-p-metodo" class="w-full px-3 py-2 border rounded-lg">
                        <option value="Yape">Yape</option>
                        <option value="Plin">Plin</option>
                        <option value="Transferencia">Transferencia</option>
                        <option value="Efectivo">Efectivo</option>
                        <option value="DevoluciÃ³n">DevoluciÃ³n</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-1">Fecha de Pago</label>
                    <input type="date" id="inp-p-fecha" class="w-full px-3 py-2 border rounded-lg">
                </div>

                <div>
                    <label class="block text-sm font-medium mb-1">Notas (Opcional)</label>
                    <textarea id="inp-p-notas" class="w-full px-3 py-2 border rounded-lg" rows="2"
                        placeholder="Motivo de la devoluciÃ³n o comentario del pago"></textarea>
                </div>
            </div>

            <div class="p-6 border-t flex justify-center gap-3">
                <button onclick="closeModal('payment')" class="px-4 py-2 text-slate-600">Cancelar</button>
                <button onclick="savePayment()"
                    class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700">Guardar</button>
            </div>
        </div>
    </div>

    <!-- New Reservation Modal -->
    <div id="modal-reservation" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-overlay">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto modal-content">
            <div class="p-6 border-b flex justify-between items-center sticky top-0 bg-white z-10">
                <h3 class="text-lg font-bold">Nueva Reserva</h3>
                <button onclick="closeModal('reservation')" class="text-slate-400 hover:text-slate-600">&times;</button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Cliente *</label>
                    <div class="relative">
                        <input type="text" id="inp-r-cliente-search"
                            placeholder="Buscar cliente por nombre o telÃ©fono..."
                            class="w-full px-3 py-2 border rounded-lg" autocomplete="off">
                        <input type="hidden" id="inp-r-cliente">
                        <div id="inp-r-cliente-options"
                            class="absolute z-20 w-full bg-white border border-slate-200 rounded-lg shadow-lg max-h-48 overflow-y-auto hidden top-full mt-1">
                            <!-- Options populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2">Tours * (Selecciona uno o mÃ¡s)</label>
                    <div id="tour-checkboxes" class="space-y-2 max-h-48 overflow-y-auto border rounded-lg p-3">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">PAX *</label>
                        <input type="number" id="inp-r-pax" class="w-full px-3 py-2 border rounded-lg" min="1"
                            value="1">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">DuraciÃ³n (dÃ­as) *</label>
                        <input type="number" id="inp-r-duracion" class="w-full px-3 py-2 border rounded-lg" min="1"
                            value="1">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Fecha de Reserva *</label>
                        <input type="date" id="inp-r-fecha" class="w-full px-3 py-2 border rounded-lg">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-1">Punto de Embarque</label>
                    <input type="text" id="inp-r-punto-embarque" class="w-full px-3 py-2 border rounded-lg"
                        placeholder="Ej: Plaza de Armas / Hotel X">
                </div>

                <div>
                    <label class="block text-sm font-medium mb-1">Monto Total *</label>
                    <input type="number" id="inp-r-monto" class="w-full px-3 py-2 border rounded-lg" step="0.01"
                        placeholder="300.00">
                </div>
            </div>
            <div class="p-6 border-t flex justify-end gap-3">
                <button onclick="closeModal('reservation')" class="px-4 py-2 text-slate-600">Cancelar</button>
                <button onclick="saveReservation()"
                    class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700">Crear Reserva</button>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div id="modal-export" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-overlay">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm modal-content">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-lg font-bold" id="export-modal-title">Exportar Datos</h3>
                <button onclick="closeModal('export')" class="text-slate-400 hover:text-slate-600">&times;</button>
            </div>
            <div class="p-6 space-y-4">
                <input type="hidden" id="inp-export-type">

                <div>
                    <label class="block text-sm font-medium mb-1">Rango de Fechas</label>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <span class="text-xs text-slate-500">Desde</span>
                            <input type="date" id="inp-export-from" class="w-full px-3 py-2 border rounded-lg text-sm">
                        </div>
                        <div>
                            <span class="text-xs text-slate-500">Hasta</span>
                            <input type="date" id="inp-export-to" class="w-full px-3 py-2 border rounded-lg text-sm">
                        </div>
                    </div>
                </div>

                <div id="div-export-status">
                    <label class="block text-sm font-medium mb-1">Estado</label>
                    <select id="inp-export-status" class="w-full px-3 py-2 border rounded-lg text-sm">
                        <option value="all">Todos</option>
                        <option value="Lead">Leads (Solo Contactos)</option>
                        <option value="Cliente">Clientes (Solo Contactos)</option>
                        <option value="Pendiente">Pendientes</option>
                        <option value="Confirmada">Confirmadas</option>
                        <option value="Completada">Completadas</option>
                        <option value="Cancelada">Canceladas</option>
                    </select>
                </div>

                <p class="text-xs text-slate-500 italic">
                    * Se descargarÃ¡n todas las filas que coincidan con los filtros, formato Excel (.xlsx).
                </p>
            </div>
            <div class="p-6 border-t flex justify-end gap-3">
                <button onclick="closeModal('export')" class="px-4 py-2 text-slate-600">Cancelar</button>
                <button onclick="generateExport()"
                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2">
                    <span>ðŸ“„</span> Descargar Excel
                </button>
            </div>
        </div>
    </div>

    <!-- Reservation Detail Modal -->
    <div id="modal-reservation-detail" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-overlay">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto modal-content">
            <div class="p-6 border-b flex justify-between items-center sticky top-0 bg-white z-10">
                <h3 class="text-lg font-bold">Detalles de Reserva</h3>
                <button onclick="closeModal('reservation-detail')"
                    class="text-slate-400 hover:text-slate-600">&times;</button>
            </div>
            <div class="p-6 space-y-6" id="reservation-detail-content">
                <!-- Content will be populated by JavaScript -->
            </div>
            <div class="p-6 border-t flex justify-end gap-3 sticky bottom-0 bg-white">
                <button onclick="closeModal('reservation-detail')" class="px-4 py-2 text-slate-600">Cerrar</button>
            </div>
        </div>
    </div>

    <script>
        // SUPABASE CONFIG
        const SUPABASE_URL = 'https://hjyacgotqmapwskzkfpu.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhqeWFjZ290cW1hcHdza3prZnB1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxMjAzOTQsImV4cCI6MjA4MTY5NjM5NH0.HX-K0lpOmGKj508MSg3LTF7Y-9r_LB62TJkb_rdgsx4';

        let db = null;
        let chartForecast = null;
        let chartContacts = null;
        let availableTours = [];

        const ITEMS_PER_PAGE = 10;
        let pages = { contacts: 0, reservations: 0, payments: 0 };
        let totalCounts = { contacts: 0, reservations: 0, payments: 0 };

        // Initialize
        if (window.supabase) {
            db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        } else {
            alert("Error: Supabase no cargÃ³ correctamente");
        }

        document.addEventListener('DOMContentLoaded', () => {
            switchView('dashboard');
            loadToursCache();
        });

        // NAVIGATION
        function switchView(viewName) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('bg-slate-800', 'text-white');
                el.classList.add('text-slate-300');
            });

            const target = document.getElementById(`view-${viewName}`);
            const nav = document.getElementById(`nav-${viewName}`);

            if (target) target.classList.remove('hidden');
            if (nav) {
                nav.classList.add('bg-slate-800', 'text-white');
                nav.classList.remove('text-slate-300');
            }

            if (viewName === 'dashboard') loadDashboard();
            if (viewName === 'contacts') loadContacts();
            if (viewName === 'reservations') loadReservations();
            if (viewName === 'payments') loadPayments();
            if (viewName === 'tours') loadTours();
        }

        // Load tours cache (only active tours for dropdowns)
        async function loadToursCache() {
            if (!db) return;
            try {
                const { data } = await db
                    .from('tours')
                    .select('id, nombre, precio, duracion')
                    .eq('activo', true)
                    .order('nombre');
                availableTours = data || [];
                console.log('âœ… Active tours loaded:', availableTours.length);
            } catch (e) {
                console.error('Error loading tours:', e);
            }
        }

        // TIMEZONE HELPERS (Peru = UTC-5)
        function getPeruDate() {
            const now = new Date();
            // Use toLocaleString to get Peru date
            const peruDateStr = now.toLocaleString('en-US', {
                timeZone: 'America/Lima',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
            // Convert from MM/DD/YYYY to YYYY-MM-DD
            const [month, day, year] = peruDateStr.split('/');
            return `${year}-${month}-${day}`;
        }

        function getPeruDateTime() {
            const now = new Date();
            const peruTime = new Date(now.getTime() - (5 * 60 * 60 * 1000)); // UTC-5
            return peruTime.toISOString().replace('T', ' ').substring(0, 19); // YYYY-MM-DD HH:MM:SS
        }

        // Format date range for tours (e.g., "26 Ene - 28 Ene")
        function formatDateRange(fechaInicio, duracion) {
            if (!fechaInicio) return '-';

            const meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];

            const inicio = new Date(fechaInicio + 'T00:00:00');
            const dias = parseInt(duracion) || 1;

            // If single day tour
            if (dias === 1) {
                const dia = inicio.getDate();
                const mes = meses[inicio.getMonth()];
                return `${dia} ${mes}`;
            }

            // Multi-day tour
            const fin = new Date(inicio);
            fin.setDate(inicio.getDate() + dias - 1);

            const diaInicio = inicio.getDate();
            const mesInicio = meses[inicio.getMonth()];
            const diaFin = fin.getDate();
            const mesFin = meses[fin.getMonth()];

            // Same month
            if (inicio.getMonth() === fin.getMonth()) {
                return `${diaInicio} - ${diaFin} ${mesFin}`;
            }

            // Different months
            return `${diaInicio} ${mesInicio} - ${diaFin} ${mesFin}`;
        }

        // DASHBOARD
        async function loadDashboard() {
            if (!db) return;

            try {
                const { data: forecastData } = await db.rpc('get_operational_forecast');
                renderOperationalForecast();

                updateDashboardPeriod('month');
            } catch (e) {
                console.error('Dashboard error:', e);
            }
        }

        async function updateDashboardStats(startDate) {
            try {
                const dateStr = startDate.toISOString().split('T')[0];
                const { data: stats, error } = await db.rpc('get_dashboard_stats', { p_start_date: dateStr });

                if (error) throw error;

                if (stats) {
                    document.getElementById('metric-revenue').textContent = `S/ ${stats.revenue}`;
                    document.getElementById('metric-conversion').textContent = `${stats.tourists} / ${stats.leads}`;
                    document.getElementById('metric-top-tour').textContent = stats.top_tour || '--';
                    document.getElementById('metric-top-origin').textContent = stats.top_origin || '--';
                }
            } catch (e) {
                console.error('Stats error:', e);
            }
        }

        // OPERATIONAL FORECAST TIMELINE
        const tourColorPalette = ['#10b981', '#3b82f6', '#f59e0b', '#8b5cf6', '#ec4899', '#14b8a6', '#f97316', '#06b6d4'];
        let tourColors = {};

        function assignTourColors(tours) {
            const uniqueTours = [...new Set(tours)];
            uniqueTours.forEach((tour, index) => {
                if (!tourColors[tour]) {
                    tourColors[tour] = tourColorPalette[index % tourColorPalette.length];
                }
            });
        }

        function getNext5Days() {
            const days = [];
            const peruToday = getPeruDate(); // "YYYY-MM-DD"
            const [year, month, day] = peruToday.split('-').map(Number);

            // Construct date using local components: year, monthIndex, day
            // This creates a date at 00:00:00 local time
            const baseDate = new Date(year, month - 1, day);

            for (let i = 0; i < 5; i++) {
                const date = new Date(baseDate);
                date.setDate(baseDate.getDate() + i);

                // Format manually using local components to avoid UTC shifts
                const y = date.getFullYear();
                const m = String(date.getMonth() + 1).padStart(2, '0');
                const d = String(date.getDate()).padStart(2, '0');

                days.push(`${y}-${m}-${d}`);
            }
            return days;
        }

        function getReservationsForDay(date, reservations) {
            return reservations.filter(r => {
                const startDate = new Date(r.fecha_reserva + 'T00:00:00');
                const endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + (parseInt(r.duracion) || 1) - 1);
                const checkDate = new Date(date + 'T00:00:00');
                return checkDate >= startDate && checkDate <= endDate;
            });
        }

        async function renderOperationalForecast() {
            const container = document.getElementById('forecast-timeline');
            if (!container) return;

            try {
                // Get next 5 days
                const days = getNext5Days();
                const startDate = days[0];
                const endDate = days[4];

                // Fetch all active reservations (we'll filter by date overlap in JS)
                // Need to get reservations that might have started before but are still active
                const lookbackDate = new Date(startDate);
                lookbackDate.setDate(lookbackDate.getDate() - 30); // Look back 30 days for long tours

                const { data: allReservations, error } = await db
                    .from('reservas')
                    .select('*, contacto_id, tour_id')
                    .gte('fecha_reserva', lookbackDate.toISOString().split('T')[0])
                    .neq('estado', 'Cancelada')
                    .in('estado_pago', ['Parcial', 'Pagado']); // Filter by payment status

                if (error) throw error;

                // Filter reservations that overlap with our 5-day window
                const reservations = allReservations?.filter(r => {
                    const resStart = new Date(r.fecha_reserva);
                    const resEnd = new Date(resStart);
                    resEnd.setDate(resStart.getDate() + (parseInt(r.duracion) || 1) - 1);
                    const windowStart = new Date(startDate);
                    const windowEnd = new Date(endDate);

                    // Check if reservation overlaps with window
                    return resEnd >= windowStart && resStart <= windowEnd;
                }) || [];

                if (!reservations || reservations.length === 0) {
                    container.innerHTML = '<div class="text-center text-slate-500 py-8">No hay reservas en los prÃ³ximos 5 dÃ­as</div>';
                    return;
                }

                // Fetch contact and tour names
                const contactIds = [...new Set(reservations.map(r => r.contacto_id).filter(Boolean))];
                const tourIds = [...new Set(reservations.map(r => r.tour_id).filter(Boolean))];

                const { data: contacts } = await db.from('contactos').select('id, nombre_completo').in('id', contactIds);
                const { data: tours } = await db.from('tours').select('id, nombre').in('id', tourIds);

                const contactMap = {};
                const tourMap = {};
                contacts?.forEach(c => contactMap[c.id] = c.nombre_completo);
                tours?.forEach(t => tourMap[t.id] = t.nombre);

                // Group by package (creado_en)
                const grouped = {};
                reservations.forEach(r => {
                    const key = r.creado_en || r.id;
                    if (!grouped[key]) {
                        grouped[key] = {
                            ...r,
                            tours: [],
                            tour_names: []
                        };
                    }
                    grouped[key].tours.push(r.tour_id);
                    grouped[key].tour_names.push(tourMap[r.tour_id] || 'N/A');
                });

                const packages = Object.values(grouped);

                // Assign colors to tour combinations
                const packageKeys = packages.map(p => [...p.tour_names].sort().join(' + '));
                assignTourColors(packageKeys);

                // Render timeline
                container.innerHTML = `
                    <div class="grid grid-cols-5 gap-2">
                        ${days.map(day => {
                    const dayReservations = getReservationsForDay(day, packages);
                    // Use manual parsing to avoid timezone issues
                    const [year, month, dayNum] = day.split('-').map(Number);
                    const monthNames = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                    const dayLabel = `${dayNum} ${monthNames[month - 1]}`;

                    return `
                                <div class="flex flex-col">
                                    <div class="text-center font-semibold text-sm text-slate-700 mb-2">${dayLabel}</div>
                                    <div class="flex-1 bg-slate-50 rounded-lg border border-slate-200 p-2 min-h-[300px] max-h-[400px] overflow-y-auto space-y-1">
                                        ${dayReservations.length === 0 ? '<div class="text-xs text-slate-400 text-center py-4">Sin reservas</div>' :
                            dayReservations.map(pkg => {
                                const tourName = pkg.tour_names.length > 1 ? `${pkg.tour_names.length} tours` : pkg.tour_names[0];
                                const tourKey = [...pkg.tour_names].sort().join(' + ');
                                const color = tourColors[tourKey] || '#64748b';
                                const height = Math.max(40, (pkg.PAX || 1) * 20);
                                const cliente = contactMap[pkg.contacto_id] || 'N/A';

                                const reservaData = JSON.stringify({
                                    id: pkg.id,
                                    creado_en: pkg.creado_en,
                                    cliente: cliente,
                                    contacto_id: pkg.contacto_id,
                                    tours: pkg.tour_names,
                                    tourCount: pkg.tour_names.length,
                                    PAX: pkg.PAX || 0,
                                    fecha_reserva: pkg.fecha_reserva || '-',
                                    duracion: pkg.duracion || 1,
                                    monto_total: pkg.monto_total || 0,
                                    balance: 0,
                                    estado: pkg.estado || 'Pendiente',
                                    estado_pago: pkg.estado_pago || 'Pendiente',
                                    reserva_ids: [pkg.id]
                                }).replace(/"/g, '&quot;');

                                return `
                                                    <div class="reservation-block rounded-lg p-2 cursor-pointer hover:brightness-110 transition-all relative group"
                                                         style="background-color: ${color}; height: ${height}px; min-height: 40px;"
                                                         onclick='openReservationDetail(${reservaData})'
                                                         title="${cliente} - ${tourName} - ${pkg.PAX} PAX">
                                                        <div class="text-white text-xs font-medium truncate">${tourName}</div>
                                                        <div class="text-white text-xs opacity-90">${pkg.PAX} PAX</div>
                                                        
                                                        <!-- Tooltip -->
                                                        <div class="hidden group-hover:block absolute z-50 bg-white border border-slate-300 rounded-lg shadow-lg p-3 -top-2 left-full ml-2 w-48 text-slate-800">
                                                            <div class="font-semibold text-sm mb-1">${cliente}</div>
                                                            <div class="text-xs text-slate-600 mb-1">${pkg.tour_names.join(', ')}</div>
                                                            <div class="text-xs"><span class="font-medium">PAX:</span> ${pkg.PAX}</div>
                                                            <div class="text-xs"><span class="font-medium">Fechas:</span> ${formatDateRange(pkg.fecha_reserva, pkg.duracion)}</div>
                                                            <div class="text-xs"><span class="font-medium">Estado:</span> ${pkg.estado}</div>
                                                        </div>
                                                    </div>
                                                `;
                            }).join('')
                        }
                                    </div>
                                </div>
                            `;
                }).join('')}
                    </div>
                `;
            } catch (e) {
                console.error('Forecast timeline error:', e);
                container.innerHTML = '<div class="text-center text-red-500 py-8">Error al cargar pronÃ³stico</div>';
            }
        }

        // DASHBOARD LOGIC
        let currentPeriod = 'month'; // 'month' or 'quarter'

        async function updateDashboardPeriod(period) {
            currentPeriod = period;

            // Update buttons UI
            document.getElementById('btn-period-month').className = period === 'month'
                ? 'px-4 py-2 text-sm font-medium rounded-md transition-colors bg-blue-600 text-white'
                : 'px-4 py-2 text-sm font-medium rounded-md text-slate-600 hover:bg-slate-50 transition-colors';

            document.getElementById('btn-period-quarter').className = period === 'quarter'
                ? 'px-4 py-2 text-sm font-medium rounded-md transition-colors bg-blue-600 text-white'
                : 'px-4 py-2 text-sm font-medium rounded-md text-slate-600 hover:bg-slate-50 transition-colors';

            let startDate;
            const today = new Date();
            if (period === 'month') {
                startDate = new Date(today.getFullYear(), today.getMonth(), 1);
            } else {
                startDate = new Date(today.getFullYear(), today.getMonth() - 2, 1);
            }

            // Refresh charts
            await Promise.all([
                updateDashboardStats(startDate),
                renderPaxTrendChart(period),
                renderCityDistributionChart(period),
                renderTopToursChart(period)
            ]);
        }

        async function renderPaxTrendChart(period) {
            const ctx = document.getElementById('chartPaxTrend');
            if (!ctx) return;
            if (window.chartPaxTrendInstance) window.chartPaxTrendInstance.destroy();

            try {
                let startDate;
                const today = new Date();

                if (period === 'month') {
                    // Start of current month
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                } else {
                    // Start of 3 months ago (Quarter approach)
                    startDate = new Date(today.getFullYear(), today.getMonth() - 2, 1);
                }

                // Fetch data from CONTACTOS
                const { data: contacts, error } = await db
                    .from('contactos')
                    .select('creado_en')
                    .gte('creado_en', startDate.toISOString().split('T')[0]);

                if (error) throw error;

                // Process data based on period
                const groupedData = {};

                contacts.forEach(c => {
                    const dateDesc = new Date(c.creado_en);
                    // Adjust to local date string yyyy-mm-dd
                    const dateKey = dateDesc.toLocaleDateString('en-CA');

                    if (period === 'month') {
                        groupedData[dateKey] = (groupedData[dateKey] || 0) + 1;
                    } else {
                        const monthKey = `${dateDesc.getFullYear()}-${String(dateDesc.getMonth() + 1).padStart(2, '0')}`;
                        groupedData[monthKey] = (groupedData[monthKey] || 0) + 1;
                    }
                });

                // Sort keys
                const labels = Object.keys(groupedData).sort();
                const data = labels.map(k => groupedData[k]);

                // Format labels for display
                const displayLabels = labels.map(label => {
                    if (period === 'month') {
                        const [y, m, d] = label.split('-');
                        return `${d}/${m}`;
                    } else {
                        const [y, m] = label.split('-');
                        const monthNames = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                        return `${monthNames[parseInt(m) - 1]} ${y}`;
                    }
                });

                // Render Line Chart
                window.chartPaxTrendInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: displayLabels,
                        datasets: [{
                            label: 'Nuevos Contactos',
                            data: data,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: true,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                intersect: false,
                                mode: 'index'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { precision: 0 }
                            }
                        }
                    }
                });

            } catch (e) {
                console.error("Pax trend error", e);
            }
        }

        async function renderCityDistributionChart(period = 'month') {
            const ctx = document.getElementById('chartCities');
            if (!ctx) return;
            if (window.chartCitiesInstance) window.chartCitiesInstance.destroy();

            try {
                let startDate;
                const today = new Date();

                if (period === 'month') {
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                } else {
                    startDate = new Date(today.getFullYear(), today.getMonth() - 2, 1);
                }

                const { data: reservations, error } = await db
                    .from('reservas')
                    .select('contacto_id, PAX')
                    .in('estado_pago', ['Parcial', 'Pagado'])
                    .neq('estado', 'Cancelada')
                    .gte('fecha_reserva', startDate.toISOString().split('T')[0]);

                if (error) throw error;
                if (!reservations || reservations.length === 0) return;

                const contactIds = [...new Set(reservations.map(r => r.contacto_id).filter(Boolean))];
                if (contactIds.length === 0) return;

                const { data: contacts, error: contactError } = await db
                    .from('contactos')
                    .select('id, ciudad')
                    .in('id', contactIds);

                if (contactError) throw contactError;

                const cityPax = {};
                reservations.forEach(r => {
                    const contact = contacts.find(c => c.id === r.contacto_id);
                    const city = contact?.ciudad || 'Otro';
                    cityPax[city] = (cityPax[city] || 0) + (r.PAX || 1);
                });

                const labels = Object.keys(cityPax);
                const data = Object.values(cityPax);
                // Reuse palette but ensure enough colors
                const palette = ['#10b981', '#3b82f6', '#f59e0b', '#8b5cf6', '#ec4899', '#14b8a6', '#f97316', '#06b6d4'];

                window.chartCitiesInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: palette,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            }
                        }
                    }
                });

            } catch (e) {
                console.error("City chart error", e);
            }
        }

        async function renderTopToursChart(period) {
            const ctx = document.getElementById('chartTopTours');
            if (!ctx) return;
            if (window.chartTopToursInstance) window.chartTopToursInstance.destroy();

            try {
                let startDate;
                const today = new Date();

                if (period === 'month') {
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                } else {
                    startDate = new Date(today.getFullYear(), today.getMonth() - 2, 1);
                }

                const { data: reservations, error } = await db
                    .from('reservas')
                    .select('*, tours(nombre)')
                    .in('estado_pago', ['Parcial', 'Pagado'])
                    .neq('estado', 'Cancelada')
                    .gte('fecha_reserva', startDate.toISOString().split('T')[0]);

                if (error) throw error;

                // Aggregate PAX by Tour Name
                const tourPax = {};

                // Need to handle missing tour names if simple join
                // Better to fetch tours separately if join is tricky, but lets try join first if policy allows
                // But schema didn't show foreign key policy explicitly enabling read, although tours table is public.
                // Reverting to manual fetch to be safe and consistent with other charts.

                const { data: tours } = await db.from('tours').select('id, nombre');
                const tourMap = {};
                tours?.forEach(t => tourMap[t.id] = t.nombre);

                reservations.forEach(r => {
                    const tourName = tourMap[r.tour_id] || 'Tour Eliminado';
                    tourPax[tourName] = (tourPax[tourName] || 0) + (r.PAX || 1);
                });

                // Convert to array and sort
                const sortedTours = Object.entries(tourPax)
                    .map(([name, pax]) => ({ name, pax }))
                    .sort((a, b) => b.pax - a.pax)
                    .slice(0, 5); // Top 5

                const labels = sortedTours.map(t => t.name);
                const data = sortedTours.map(t => t.pax);

                // Render Horizontal Bar
                window.chartTopToursInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Pasajeros',
                            data: data,
                            backgroundColor: '#3b82f6',
                            borderRadius: 4
                        }]
                    },
                    options: {
                        indexAxis: 'y', // Horizontal
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                ticks: { precision: 0 }
                            }
                        }
                    }
                });

            } catch (e) {
                console.error("Top tours chart error", e);
            }
        }

        // CONTACTS
        async function loadContacts() {
            const start = pages.contacts * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE - 1;
            const tbody = document.getElementById('table-contacts-body');
            tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center">Cargando...</td></tr>';

            if (!db) return;

            try {
                const { data, count } = await db
                    .from('contactos')
                    .select('*', { count: 'exact' })
                    .order('creado_en', { ascending: false })
                    .range(start, end);

                totalCounts.contacts = count || 0;
                updatePaginationUI('contacts');

                if (!data || data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-slate-500">No hay contactos</td></tr>';
                    return;
                }

                tbody.innerHTML = data.map(c => `
                    <tr class="hover:bg-slate-50 border-b">
                        <td class="px-6 py-4 font-medium">${c.nombre_completo}</td>
                        <td class="px-6 py-4">${c.whatsapp}</td>
                        <td class="px-6 py-4">${c.ciudad || '-'}</td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 rounded text-xs ${c.estado === 'Cliente' ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-100'}">${c.estado}</span>
                        </td>
                        <td class="px-6 py-4">
                            <button onclick='editContact(${JSON.stringify(c)})' class="text-emerald-600 text-xs hover:underline">Editar</button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('Contacts error:', e);
                tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-red-500">Error al cargar</td></tr>';
            }
        }

        function openContactModal() {
            document.getElementById('contact-modal-title').textContent = 'Nuevo Contacto';
            document.getElementById('inp-c-id').value = '';
            document.getElementById('inp-c-name').value = '';
            document.getElementById('inp-c-phone').value = '';
            document.getElementById('inp-c-dni').value = '';
            document.getElementById('inp-c-city').value = 'Lima';
            document.getElementById('inp-c-source').value = 'Dashboard';
            document.getElementById('inp-c-status').value = 'Lead';
            document.getElementById('modal-contact').classList.remove('hidden');
        }

        function editContact(contact) {
            document.getElementById('contact-modal-title').textContent = 'Editar Contacto';
            document.getElementById('inp-c-id').value = contact.id;
            document.getElementById('inp-c-name').value = contact.nombre_completo;
            document.getElementById('inp-c-phone').value = contact.whatsapp;
            document.getElementById('inp-c-dni').value = contact.dni || '';
            document.getElementById('inp-c-city').value = contact.ciudad;
            document.getElementById('inp-c-source').value = contact.fuente;
            document.getElementById('inp-c-status').value = contact.estado;
            document.getElementById('modal-contact').classList.remove('hidden');
        }

        async function saveContact() {
            const id = document.getElementById('inp-c-id').value;
            const name = document.getElementById('inp-c-name').value.trim();
            const phone = document.getElementById('inp-c-phone').value.trim();
            const dni = document.getElementById('inp-c-dni').value.trim() || null;
            const city = document.getElementById('inp-c-city').value;
            const source = document.getElementById('inp-c-source').value;
            const status = document.getElementById('inp-c-status').value;

            if (!name || !phone) {
                alert('Nombre y Whatsapp son obligatorios');
                return;
            }

            const payload = {
                id: id || crypto.randomUUID(),
                nombre_completo: name,
                whatsapp: phone,
                dni: dni,
                ciudad: city,
                fuente: source,
                estado: status
            };

            try {
                let result;
                if (id) {
                    result = await db.from('contactos').update(payload).eq('id', id);
                } else {
                    result = await db.from('contactos').insert(payload);
                }

                if (result.error) {
                    alert('Error: ' + result.error.message);
                } else {
                    closeModal('contact');
                    loadContacts();
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        // RESERVATIONS
        async function loadReservations() {
            const start = pages.reservations * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE - 1;
            const tbody = document.getElementById('table-reservations-body');
            tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center">Cargando...</td></tr>';

            if (!db) return;

            try {
                const { data, count, error } = await db
                    .from('reservas')
                    .select('*, contacto_id, tour_id', { count: 'exact' })
                    .order('creado_en', { ascending: false })
                    .range(start, end);

                if (error) {
                    console.error('Query error:', error);
                    tbody.innerHTML = `<tr><td colspan="7" class="px-6 py-4 text-center text-red-500">Error: ${error.message}</td></tr>`;
                    return;
                }

                totalCounts.reservations = count || 0;
                updatePaginationUI('reservations');

                if (!data || data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-8 text-center text-slate-500">No hay reservas</td></tr>';
                    return;
                }

                // Fetch contact and tour names for all reservations
                const contactIds = [...new Set(data.map(r => r.contacto_id).filter(Boolean))];
                const tourIds = [...new Set(data.map(r => r.tour_id).filter(Boolean))];

                const { data: contacts } = await db.from('contactos').select('id, nombre_completo').in('id', contactIds);
                const { data: tours } = await db.from('tours').select('id, nombre').in('id', tourIds);

                const contactMap = {};
                const tourMap = {};
                contacts?.forEach(c => contactMap[c.id] = c.nombre_completo);
                tours?.forEach(t => tourMap[t.id] = t.nombre);

                // Group reservations by creation timestamp (same timestamp = same package)
                const grouped = {};
                data.forEach(r => {
                    const key = r.creado_en || r.id; // Use creation timestamp as key
                    if (!grouped[key]) {
                        grouped[key] = {
                            ...r,
                            tours: [],
                            reserva_ids: [] // Track all reservation IDs in package
                        };
                    }
                    grouped[key].tours.push(tourMap[r.tour_id] || 'N/A');
                    grouped[key].reserva_ids.push(r.id);
                });

                const packages = Object.values(grouped);

                // Fetch payments for all reservations to calculate balance
                const allReservaIds = packages.flatMap(p => p.reserva_ids);
                const { data: payments } = await db
                    .from('pagos')
                    .select('reserva_id, monto')
                    .in('reserva_id', allReservaIds);

                // Calculate balance for each reservation
                const balanceMap = {};
                payments?.forEach(p => {
                    if (!balanceMap[p.reserva_id]) balanceMap[p.reserva_id] = 0;
                    balanceMap[p.reserva_id] += parseFloat(p.monto);
                });

                tbody.innerHTML = packages.map(pkg => {
                    const toursList = pkg.tours.join(', ');
                    const tourCount = pkg.tours.length;

                    // Calculate total balance for this package
                    const totalBalance = pkg.reserva_ids.reduce((sum, id) => sum + (balanceMap[id] || 0), 0);
                    const montoTotal = parseFloat(pkg.monto_total) || 0;

                    // Determine payment status
                    let estadoPago = 'Pendiente';
                    let estadoPagoColor = 'bg-slate-100 text-slate-700';

                    if (totalBalance >= montoTotal) {
                        estadoPago = 'Pagado';
                        estadoPagoColor = 'bg-emerald-100 text-emerald-700';
                    } else if (totalBalance > 0) {
                        estadoPago = 'Parcial';
                        estadoPagoColor = 'bg-yellow-100 text-yellow-700';
                    } else if (totalBalance < 0) {
                        estadoPago = 'Reembolsado';
                        estadoPagoColor = 'bg-blue-100 text-blue-700';
                    }

                    // Prepare data for modal
                    const reservaData = JSON.stringify({
                        id: pkg.id,
                        creado_en: pkg.creado_en,
                        cliente: contactMap[pkg.contacto_id] || 'N/A',
                        contacto_id: pkg.contacto_id,
                        tours: pkg.tours,
                        tourCount: tourCount,
                        PAX: pkg.PAX || 0,
                        fecha_reserva: pkg.fecha_reserva || '-',
                        duracion: pkg.duracion || 1,
                        monto_total: montoTotal,
                        balance: totalBalance,
                        estado: pkg.estado || 'Pendiente',
                        estado_pago: estadoPago,
                        reserva_ids: pkg.reserva_ids
                    }).replace(/"/g, '&quot;');

                    return `
                    <tr class="hover:bg-emerald-50 border-b cursor-pointer transition-colors" onclick='openReservationDetail(${reservaData})'>
                        <td class="px-6 py-4 font-medium">${contactMap[pkg.contacto_id] || 'N/A'}</td>
                        <td class="px-6 py-4">
                            ${tourCount > 1 ? `<span class="font-bold text-emerald-600">${tourCount} tours</span>` : toursList}
                        </td>
                        <td class="px-6 py-4">${formatDateRange(pkg.fecha_reserva, pkg.duracion)}</td>
                        <td class="px-6 py-4 text-right">
                            <div class="text-sm font-bold">S/ ${totalBalance.toFixed(2)} / ${montoTotal.toFixed(2)}</div>
                            <div class="text-xs ${totalBalance < montoTotal ? 'text-orange-600' : 'text-emerald-600'}">
                                ${totalBalance >= montoTotal ? 'Completo' : `Falta: S/ ${(montoTotal - totalBalance).toFixed(2)}`}
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex flex-col gap-1">
                                <span class="px-2 py-1 rounded text-xs ${pkg.estado === 'Confirmada' ? 'bg-emerald-100 text-emerald-700' :
                            pkg.estado === 'Pendiente' ? 'bg-yellow-100 text-yellow-700' :
                                pkg.estado === 'Cancelada' ? 'bg-red-100 text-red-700' :
                                    'bg-blue-100 text-blue-700'
                        }">${pkg.estado || 'Pendiente'}</span>
                                <span class="px-2 py-1 rounded text-xs ${estadoPagoColor}">${estadoPago}</span>
                            </div>
                        </td>
                    </tr>
                `}).join('');
            } catch (e) {
                console.error('Reservations error:', e);
                tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-red-500">Error al cargar</td></tr>';
            }
        }

        // Helper for searchable dropdown
        window.selectClient = function (id, name, pax, embarque) {
            document.getElementById('inp-r-cliente').value = id;
            document.getElementById('inp-r-cliente-search').value = name;

            // Auto-fill logic
            if (pax) document.getElementById('inp-r-pax').value = pax;
            if (embarque) document.getElementById('inp-r-punto-embarque').value = embarque;

            document.getElementById('inp-r-cliente-options').classList.add('hidden');
        };

        async function openReservationModal() {
            // Load contacts for dropdown
            const { data: contacts } = await db.from('contactos')
                .select('id, nombre_completo, whatsapp, ultimo_pax, ultimo_punto_embarque') // Fetch new columns
                .order('nombre_completo');

            const searchInput = document.getElementById('inp-r-cliente-search');
            const hiddenInput = document.getElementById('inp-r-cliente');
            const optionsContainer = document.getElementById('inp-r-cliente-options');

            // Reset inputs
            searchInput.value = '';
            hiddenInput.value = '';

            // Render options function
            const renderOptions = (list) => {
                if (!list || list.length === 0) {
                    optionsContainer.innerHTML = '<div class="p-3 text-sm text-slate-500 text-center">No se encontraron clientes</div>';
                    return;
                }

                optionsContainer.innerHTML = list.map(c => `
                    <div class="px-3 py-2 hover:bg-emerald-50 cursor-pointer border-b last:border-0 transition-colors"
                        onclick="selectClient('${c.id}', '${c.nombre_completo}', '${c.ultimo_pax || 1}', '${c.ultimo_punto_embarque || ''}')">
                        <div class="font-medium text-sm text-slate-800">${c.nombre_completo}</div>
                        <div class="text-xs text-slate-500">${c.whatsapp || 'Sin whatsapp'}</div>
                    </div>
                `).join('');
            };

            // Setup Event Listeners
            searchInput.onfocus = () => {
                renderOptions(contacts);
                optionsContainer.classList.remove('hidden');
            };

            // Delay hiding to allow click event to register
            searchInput.onblur = () => {
                setTimeout(() => optionsContainer.classList.add('hidden'), 200);
            };

            searchInput.oninput = (e) => {
                const term = e.target.value.toLowerCase();
                const filtered = contacts?.filter(c =>
                    (c.nombre_completo && c.nombre_completo.toLowerCase().includes(term)) ||
                    (c.whatsapp && c.whatsapp.includes(term))
                );
                renderOptions(filtered);
                optionsContainer.classList.remove('hidden');
            };

            // Load tours for checkboxes
            const toursContainer = document.getElementById('tour-checkboxes');
            toursContainer.innerHTML = availableTours.map(t => `
                <label class="flex items-center gap-2 cursor-pointer hover:bg-slate-50 p-2 rounded">
                    <input type="checkbox" name="tour" value="${t.id}" class="rounded">
                    <span>${t.nombre}</span>
                </label>
            `).join('');

            // Set default date to today
            document.getElementById('inp-r-fecha').value = getPeruDate();

            // Clear other fields
            document.getElementById('inp-r-pax').value = '1';
            document.getElementById('inp-r-duracion').value = '1';
            document.getElementById('inp-r-monto').value = '';
            document.getElementById('inp-r-punto-embarque').value = '';

            document.getElementById('modal-reservation').classList.remove('hidden');
        }

        async function saveReservation() {
            const clienteId = document.getElementById('inp-r-cliente').value;
            const selectedTours = Array.from(document.querySelectorAll('input[name="tour"]:checked')).map(cb => cb.value);
            const pax = parseInt(document.getElementById('inp-r-pax').value);
            const duracion = parseInt(document.getElementById('inp-r-duracion').value);
            const fecha = document.getElementById('inp-r-fecha').value;
            const montoTotal = parseFloat(document.getElementById('inp-r-monto').value);
            const puntoEmbarque = document.getElementById('inp-r-punto-embarque').value.trim() || null;

            // Validation
            if (!clienteId) {
                alert('Debe seleccionar un cliente');
                return;
            }
            if (selectedTours.length === 0) {
                alert('Debe seleccionar al menos un tour');
                return;
            }
            if (!pax || pax < 1) {
                alert('PAX debe ser al menos 1');
                return;
            }
            if (!duracion || duracion < 1) {
                alert('DuraciÃ³n debe ser al menos 1 dÃ­a');
                return;
            }
            if (!fecha) {
                alert('Debe ingresar una fecha');
                return;
            }
            // Allow 0 for partial reservations if that's the intent, 
            // but user said "Partial Reservations" in DB. 
            // Here in UI we usually enforce it unless we relax it.
            // Requirement was: "Verify... Insert Reservation handles missing...".
            // Since user is Manually inserting, let's keep validation but update payload.
            if (!montoTotal || montoTotal <= 0) {
                alert('Debe ingresar un monto total vÃ¡lido');
                return;
            }

            if (!db) return;

            try {
                // Create timestamp for grouping (Peru time)
                const creadoEn = getPeruDateTime();

                // Calculate initial status based on date
                const today = getPeruDate();
                const initialStatus = (fecha === today) ? 'En Curso' : 'Pendiente';

                // Create one reservation per tour
                const reservations = selectedTours.map(tourId => ({
                    id: crypto.randomUUID(),
                    contacto_id: clienteId,
                    tour_id: tourId,
                    PAX: pax,
                    duracion: duracion,
                    fecha_reserva: fecha,
                    monto_total: montoTotal,
                    punto_embarque: puntoEmbarque,
                    estado: initialStatus,
                    estado_pago: 'Pendiente',
                    creado_en: creadoEn
                }));

                const { error } = await db.from('reservas').insert(reservations);

                if (error) {
                    alert('Error: ' + error.message);
                } else {
                    alert(`Reserva creada exitosamente con ${selectedTours.length} tour(s)\nEstado inicial: ${initialStatus}`);
                    closeModal('reservation');
                    loadReservations();
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function openReservationDetail(data) {
            const content = document.getElementById('reservation-detail-content');

            // Fetch payment history for this reservation
            const { data: payments } = await db
                .from('pagos')
                .select('*')
                .in('reserva_id', data.reserva_ids)
                .order('fecha_pago', { ascending: false });

            const paymentHistory = payments?.map(p => `
                <div class="flex justify-between items-center py-2 border-b">
                    <div>
                        <div class="font-medium ${p.monto < 0 ? 'text-red-600' : ''}">S/ ${p.monto}</div>
                        <div class="text-xs text-slate-500">${p.metodo_pago} - ${p.fecha_pago ? p.fecha_pago.split('T')[0] : '-'}</div>
                        ${p.notas ? `<div class="text-xs text-slate-400 italic">"${p.notas}"</div>` : ''}
                    </div>
                    ${p.monto > 0 ? `<button onclick='openRefundModal(${JSON.stringify({ reserva_id: p.reserva_id, cliente: data.cliente, monto_original: p.monto }).replace(/"/g, "&quot;")})' class="text-orange-600 text-xs hover:underline">DevoluciÃ³n</button>` : ''}
                </div>
            `).join('') || '<p class="text-slate-500 text-sm">No hay pagos registrados</p>';

            content.innerHTML = `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs font-semibold text-slate-500 uppercase">Cliente</label>
                            <p class="text-lg font-bold">${data.cliente}</p>
                        </div>
                        <div>
                            <label class="text-xs font-semibold text-slate-500 uppercase">Fecha del Tour</label>
                            <p class="text-lg">${formatDateRange(data.fecha_reserva, data.duracion)}</p>
                        </div>
                    </div>

                    <div>
                        <label class="text-xs font-semibold text-slate-500 uppercase">Tours (${data.tourCount})</label>
                        <ul class="mt-2 space-y-1">
                            ${data.tours.map(t => `<li class="flex items-center gap-2"><span class="w-2 h-2 bg-emerald-600 rounded-full"></span>${t}</li>`).join('')}
                        </ul>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs font-semibold text-slate-500 uppercase">PAX</label>
                            <p class="text-2xl font-bold">${data.PAX}</p>
                        </div>
                        <div>
                            <label class="text-xs font-semibold text-slate-500 uppercase">Monto Total</label>
                            <p class="text-2xl font-bold">S/ ${data.monto_total.toFixed(2)}</p>
                        </div>
                    </div>

                    <div class="bg-slate-50 p-4 rounded-lg">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-semibold">Balance de Pagos</span>
                            <span class="text-2xl font-bold ${data.balance >= data.monto_total ? 'text-emerald-600' : 'text-orange-600'}">
                                S/ ${data.balance.toFixed(2)}
                            </span>
                        </div>
                        <div class="text-sm text-slate-600">
                            ${data.balance >= data.monto_total ? 'âœ“ Pagado completo' : `Falta: S/ ${(data.monto_total - data.balance).toFixed(2)}`}
                        </div>
                    </div>

                    <div>
                        <div class="flex justify-between items-center mb-3">
                            <label class="text-xs font-semibold text-slate-500 uppercase">Historial de Pagos</label>
                            <button onclick="openPaymentFromDetail('${data.id}', '${data.cliente}')" class="text-blue-600 text-sm hover:underline">+ Registrar Pago</button>
                        </div>
                        <div class="space-y-2">
                            ${paymentHistory}
                        </div>
                    </div>

                    <div class="flex gap-2 pt-4">
                        <span class="px-3 py-1 rounded text-sm ${data.estado === 'Confirmada' ? 'bg-emerald-100 text-emerald-700' :
                    data.estado === 'Pendiente' ? 'bg-yellow-100 text-yellow-700' :
                        data.estado === 'Cancelada' ? 'bg-red-100 text-red-700' :
                            'bg-blue-100 text-blue-700'
                }">${data.estado}</span>
                        <span class="px-3 py-1 rounded text-sm ${data.estado_pago === 'Pagado' ? 'bg-emerald-100 text-emerald-700' :
                    data.estado_pago === 'Parcial' ? 'bg-yellow-100 text-yellow-700' :
                        data.estado_pago === 'Reembolsado' ? 'bg-blue-100 text-blue-700' :
                            'bg-slate-100 text-slate-700'
                }">${data.estado_pago}</span>
                    </div>

                    ${data.estado !== 'Cancelada' ? `
                    <div class="flex gap-3 pt-4 border-t">
                        <button onclick="cancelReservation('${data.creado_en}')" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                            Cancelar Reserva
                        </button>
                    </div>
                    ` : ''}
                </div>
            `;

            document.getElementById('modal-reservation-detail').classList.remove('hidden');
        }

        // PAYMENTS
        async function loadPayments() {
            const start = pages.payments * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE - 1;
            const tbody = document.getElementById('table-payments-body');
            tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center">Cargando...</td></tr>';

            if (!db) return;

            try {
                const { data, count, error } = await db
                    .from('pagos')
                    .select('*, reserva_id', { count: 'exact' })
                    .order('fecha_pago', { ascending: false })
                    .range(start, end);

                if (error) {
                    console.error('Payments query error:', error);
                    tbody.innerHTML = `<tr><td colspan="5" class="px-6 py-4 text-center text-red-500">Error: ${error.message}</td></tr>`;
                    return;
                }

                totalCounts.payments = count || 0;
                updatePaginationUI('payments');

                if (!data || data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-slate-500">No hay pagos</td></tr>';
                    return;
                }

                // Fetch reservation info (to get creado_en and verify package)
                const reservaIds = [...new Set(data.map(p => p.reserva_id).filter(Boolean))];
                const { data: reservas } = await db.from('reservas').select('id, contacto_id, tour_id, creado_en').in('id', reservaIds);

                // Find all packages (shared creation dates)
                const timestamps = [...new Set(reservas?.map(r => r.creado_en).filter(Boolean))];

                // Fetch ALL reservations that belong to these packages (same created_en)
                const { data: siblingReservas } = await db.from('reservas')
                    .select('id, tour_id, creado_en')
                    .in('creado_en', timestamps);

                const contactIds = [...new Set(reservas?.map(r => r.contacto_id).filter(Boolean) || [])];
                const allTourIds = [...new Set(siblingReservas?.map(r => r.tour_id).filter(Boolean) || [])];

                const { data: contacts } = await db.from('contactos').select('id, nombre_completo').in('id', contactIds);
                const { data: tours } = await db.from('tours').select('id, nombre').in('id', allTourIds);

                const contactMap = {};
                contacts?.forEach(c => contactMap[c.id] = c.nombre_completo);

                const tourMap = {};
                tours?.forEach(t => tourMap[t.id] = t.nombre);

                // Group tours by package (creado_en)
                const packageTours = {};
                siblingReservas?.forEach(r => {
                    const key = r.creado_en;
                    if (!packageTours[key]) packageTours[key] = [];
                    if (r.tour_id && tourMap[r.tour_id]) {
                        packageTours[key].push(tourMap[r.tour_id]);
                    }
                });

                const reservaMap = {};
                reservas?.forEach(r => reservaMap[r.id] = r);

                tbody.innerHTML = data.map(p => {
                    const reserva = reservaMap[p.reserva_id] || {};
                    const clientName = contactMap[reserva.contacto_id] || 'N/A';

                    // Get all tours for this package
                    const packageKey = reserva.creado_en;
                    const uniqueTours = packageTours[packageKey] ? [...new Set(packageTours[packageKey])] : [];

                    // Format tours vertically
                    const toursHtml = uniqueTours.length > 0
                        ? uniqueTours.map(t => `<div class="mb-1 last:mb-0">${t}</div>`).join('')
                        : '-';

                    return `
                    <tr class="hover:bg-slate-50 border-b">
                        <td class="px-6 py-4 align-top">${clientName}</td>
                        <td class="px-6 py-4 text-xs text-slate-500 align-top">${toursHtml}</td>
                        <td class="px-6 py-4 text-right font-bold align-top ${p.monto < 0 ? 'text-red-600' : ''}">S/ ${p.monto || 0}</td>
                        <td class="px-6 py-4 align-top">${p.metodo_pago || '-'}</td>
                        <td class="px-6 py-4 text-xs text-slate-500 max-w-[200px] truncate align-top" title="${p.notas || ''}">${p.notas || '-'}</td>
                        <td class="px-6 py-4 align-top">${p.fecha_pago ? p.fecha_pago.split('T')[0] : '-'}</td>
                    </tr>
                `}).join('');
            } catch (e) {
                console.error('Payments error:', e);
                tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-red-500">Error al cargar</td></tr>';
            }
        }


        function openPaymentModal() {
            document.getElementById('payment-modal-title').textContent = 'Registrar Pago';
            document.getElementById('inp-p-id').value = '';
            document.getElementById('inp-p-reserva-id').value = '';
            document.getElementById('inp-p-cliente').value = '';
            document.getElementById('inp-p-monto').value = '';
            document.getElementById('inp-p-metodo').value = 'Yape';
            document.getElementById('inp-p-fecha').value = new Date().toISOString().split('T')[0];
            document.getElementById('modal-payment').classList.remove('hidden');
        }

        function openRefundModal(paymentData) {
            document.getElementById('payment-modal-title').textContent = 'Registrar DevoluciÃ³n';
            document.getElementById('inp-p-id').value = '';
            document.getElementById('inp-p-reserva-id').value = paymentData.reserva_id;
            document.getElementById('inp-p-cliente').value = paymentData.cliente;
            document.getElementById('inp-p-monto').value = ''; // User will enter negative amount
            document.getElementById('inp-p-metodo').value = 'DevoluciÃ³n';
            document.getElementById('inp-p-fecha').value = new Date().toISOString().split('T')[0];
            document.getElementById('modal-payment').classList.remove('hidden');
        }

        async function openPaymentForReservation(reservaId, clientName) {
            document.getElementById('payment-modal-title').textContent = 'Registrar Pago';
            document.getElementById('inp-p-id').value = '';
            document.getElementById('inp-p-reserva-id').value = reservaId;
            document.getElementById('inp-p-cliente').value = clientName;
            document.getElementById('inp-p-monto').value = '';
            document.getElementById('inp-p-metodo').value = 'Yape';
            document.getElementById('inp-p-fecha').value = getPeruDate();

            // Fetch reservation data to get total amount and calculate balance
            try {
                // Get all reservations with same creado_en (package)
                const { data: reserva } = await db
                    .from('reservas')
                    .select('id, monto_total, creado_en')
                    .eq('id', reservaId)
                    .single();

                if (reserva) {
                    const montoTotal = parseFloat(reserva.monto_total) || 0;

                    // Get all reservations in the same package
                    const { data: packageReservas } = await db
                        .from('reservas')
                        .select('id')
                        .eq('creado_en', reserva.creado_en);

                    const reservaIds = packageReservas?.map(r => r.id) || [reservaId];

                    // Get all payments for this package
                    const { data: payments } = await db
                        .from('pagos')
                        .select('monto')
                        .in('reserva_id', reservaIds);

                    const balanceActual = payments?.reduce((sum, p) => sum + parseFloat(p.monto), 0) || 0;
                    const saldoPendiente = montoTotal - balanceActual;

                    // Store in hidden fields for validation
                    document.getElementById('inp-p-monto-total').value = montoTotal;
                    document.getElementById('inp-p-balance-actual').value = balanceActual;

                    // Display info
                    document.getElementById('info-monto-total').textContent = `S/ ${montoTotal.toFixed(2)}`;
                    document.getElementById('info-ya-pagado').textContent = `S/ ${balanceActual.toFixed(2)}`;
                    document.getElementById('info-saldo-pendiente').textContent = `S/ ${saldoPendiente.toFixed(2)}`;
                    document.getElementById('payment-reservation-info').classList.remove('hidden');
                } else {
                    // Hide info if no reservation found
                    document.getElementById('payment-reservation-info').classList.add('hidden');
                }
            } catch (e) {
                console.error('Error loading reservation data:', e);
                document.getElementById('payment-reservation-info').classList.add('hidden');
            }

            document.getElementById('modal-payment').classList.remove('hidden');
        }

        function openPaymentFromDetail(reservaId, clientName) {
            // Close detail modal first
            closeModal('reservation-detail');
            // Then open payment modal
            setTimeout(() => {
                openPaymentForReservation(reservaId, clientName);
            }, 100);
        }

        function openRefundModal(data) {
            // data contains { reserva_id, cliente, monto_original }
            closeModal('reservation-detail');
            setTimeout(async () => {
                await openPaymentForReservation(data.reserva_id, data.cliente);

                // Override fields for Refund Mode
                const refundAmount = -Math.abs(data.monto_original);
                document.getElementById('inp-p-monto').value = refundAmount;
                document.getElementById('inp-p-metodo').value = 'DevoluciÃ³n';
                document.getElementById('inp-p-notas').value = 'DevoluciÃ³n de pago';

                // Optional: visual feedback
                // document.getElementById('modal-payment').querySelector('h3').textContent = 'Registrar DevoluciÃ³n';
            }, 100);
        }

        async function savePayment() {
            const reservaId = document.getElementById('inp-p-reserva-id').value;
            const monto = parseFloat(document.getElementById('inp-p-monto').value);
            const metodo = document.getElementById('inp-p-metodo').value;
            const fecha = document.getElementById('inp-p-fecha').value;
            const notas = document.getElementById('inp-p-notas').value.trim();

            if (!reservaId) {
                alert('Debe seleccionar una reserva');
                return;
            }

            if (isNaN(monto) || monto === 0) {
                alert('Ingrese un monto vÃ¡lido (positivo para pago, negativo para devoluciÃ³n)');
                return;
            }

            // Validate payment doesn't exceed pending balance (only for positive payments)
            if (monto > 0) {
                const montoTotal = parseFloat(document.getElementById('inp-p-monto-total').value) || 0;
                const balanceActual = parseFloat(document.getElementById('inp-p-balance-actual').value) || 0;
                const saldoPendiente = montoTotal - balanceActual;

                if (monto > saldoPendiente) {
                    alert(`El pago de S/ ${monto.toFixed(2)} excede el saldo pendiente de S/ ${saldoPendiente.toFixed(2)}.\n\nMonto mÃ¡ximo permitido: S/ ${saldoPendiente.toFixed(2)}`);
                    return;
                }
            } else if (monto < 0) {
                // Validate refund doesn't exceed total paid amount
                const balanceActual = parseFloat(document.getElementById('inp-p-balance-actual').value) || 0;

                if (Math.abs(monto) > balanceActual) {
                    alert(`La devoluciÃ³n de S/ ${Math.abs(monto).toFixed(2)} excede el monto total pagado de S/ ${balanceActual.toFixed(2)}.\n\nMonto mÃ¡ximo a devolver: S/ ${balanceActual.toFixed(2)}`);
                    return;
                }
            }

            if (!db) return;

            try {
                const payload = {
                    id: crypto.randomUUID(),
                    reserva_id: reservaId,
                    monto: monto,
                    metodo_pago: metodo,
                    fecha_pago: fecha,
                    notas: notas,
                    creado_en: getPeruDateTime()
                };

                const { error } = await db.from('pagos').insert(payload);

                if (error) {
                    alert('Error: ' + error.message);
                } else {
                    // Calculate new balance and update estado_pago
                    const { data: allPayments } = await db
                        .from('pagos')
                        .select('monto')
                        .eq('reserva_id', reservaId);

                    const totalPagado = allPayments?.reduce((sum, p) => sum + parseFloat(p.monto), 0) || 0;

                    // Get reservation total AND package info
                    const { data: reserva } = await db
                        .from('reservas')
                        .select('monto_total, creado_en, contacto_id')
                        .eq('id', reservaId)
                        .single();

                    // Calculate Total Package Amount
                    const { data: packageReservas } = await db
                        .from('reservas')
                        .select('monto_total')
                        .eq('creado_en', reserva.creado_en);

                    const totalPackageAmount = packageReservas?.reduce((sum, r) => sum + (parseFloat(r.monto_total) || 0), 0) || 0;

                    // Determine new estado_pago
                    let nuevoEstadoPago = 'Pendiente';
                    if (totalPagado >= totalPackageAmount) {
                        nuevoEstadoPago = 'Pagado';
                    } else if (totalPagado > 0) {
                        nuevoEstadoPago = 'Parcial';
                    } else if (allPayments.length > 0 && totalPagado <= 0) {
                        nuevoEstadoPago = 'Reembolsado';
                    }

                    // Update estado_pago in ALL reservations of the package
                    await db
                        .from('reservas')
                        .update({ estado_pago: nuevoEstadoPago })
                        .eq('creado_en', reserva.creado_en);

                    // AUTOMATION: Promote to 'Cliente' if payment > 0
                    if (monto > 0 && reserva?.contacto_id) {
                        await db
                            .from('contactos')
                            .update({ estado: 'Cliente' })
                            .eq('id', reserva.contacto_id);
                    }

                    alert(monto > 0 ? 'Pago registrado exitosamente. Estado actualizado en todo el paquete.' : 'DevoluciÃ³n registrada exitosamente');
                    closeModal('payment');
                    loadPayments();
                    loadReservations(); // Reload to show updated status
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        // TOURS
        async function loadTours() {
            const tbody = document.getElementById('table-tours-body');
            tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center">Cargando...</td></tr>';

            if (!db) return;

            try {
                const { data } = await db
                    .from('tours')
                    .select('*')
                    .order('nombre');

                if (!data || data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-8 text-center text-slate-500">No hay tours</td></tr>';
                    return;
                }

                tbody.innerHTML = data.map(t => `
                    <tr class="hover:bg-slate-50 border-b">
                        <td class="px-6 py-4 font-medium">${t.nombre}</td>
                        <td class="px-6 py-4">${t.duracion || '-'}</td>
                        <td class="px-6 py-4 text-right">S/ ${t.precio_referencial || '0'}</td>
                        <td class="px-6 py-4">
                            <button onclick='editTour(${JSON.stringify(t)})' class="text-emerald-600 text-xs hover:underline">Editar</button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('Tours error:', e);
                tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-red-500">Error al cargar</td></tr>';
            }
        }

        async function loadToursCache() {
            if (!db) return;
            try {
                // Only load ACTIVE tours for the reservation dropdown
                const { data } = await db.from('tours').select('*').eq('activo', true).order('nombre');
                availableTours = data || [];
            } catch (e) {
                console.error('Tours cache error:', e);
            }
        }

        function openTourModal() {
            document.getElementById('tour-modal-title').textContent = 'Nuevo Tour';
            document.getElementById('inp-t-id').value = '';
            document.getElementById('inp-t-name').value = '';
            document.getElementById('inp-t-desc').value = '';
            document.getElementById('inp-t-price').value = '';
            document.getElementById('inp-t-duration').value = '';
            document.getElementById('modal-tour').classList.remove('hidden');
        }

        function editTour(tour) {
            document.getElementById('tour-modal-title').textContent = 'Editar Tour';
            document.getElementById('inp-t-id').value = tour.id;
            document.getElementById('inp-t-name').value = tour.nombre;
            document.getElementById('inp-t-desc').value = tour.descripcion || '';
            document.getElementById('inp-t-price').value = tour.precio_referencial || '';
            document.getElementById('inp-t-duration').value = tour.duracion || '';
            document.getElementById('modal-tour').classList.remove('hidden');
        }

        async function saveTour() {
            const id = document.getElementById('inp-t-id').value;
            const name = document.getElementById('inp-t-name').value.trim();
            const desc = document.getElementById('inp-t-desc').value.trim() || null;
            const price = document.getElementById('inp-t-price').value || null;
            const duration = document.getElementById('inp-t-duration').value.trim() || null;

            if (!name) {
                alert('Nombre del tour es obligatorio');
                return;
            }

            const payload = {
                id: id || crypto.randomUUID(),
                nombre: name,
                descripcion: desc,
                precio_referencial: price,
                duracion: duration
            };

            try {
                let result;
                if (id) {
                    result = await db.from('tours').update(payload).eq('id', id);
                } else {
                    result = await db.from('tours').insert(payload);
                }

                if (result.error) {
                    alert('Error: ' + result.error.message);
                } else {
                    closeModal('tour');
                    loadTours();
                    loadToursCache();
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        // PAGINATION
        function updatePaginationUI(section) {
            const currentPage = pages[section];
            const totalItems = totalCounts[section];
            const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);

            document.getElementById(`${section}-page-info`).textContent =
                `PÃ¡gina ${currentPage + 1} de ${totalPages || 1} (${totalItems} total)`;

            const btnFirst = document.getElementById(`btn-first-${section}`);
            const btnPrev = document.getElementById(`btn-prev-${section}`);
            const btnNext = document.getElementById(`btn-next-${section}`);
            const btnLast = document.getElementById(`btn-last-${section}`);

            if (btnFirst) btnFirst.disabled = currentPage === 0;
            if (btnPrev) btnPrev.disabled = currentPage === 0;
            if (btnNext) btnNext.disabled = currentPage >= totalPages - 1;
            if (btnLast) btnLast.disabled = currentPage >= totalPages - 1;
        }

        function changePage(section, direction) {
            const totalItems = totalCounts[section];
            const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);

            if (direction === 'first') {
                pages[section] = 0;
            } else if (direction === 'last') {
                pages[section] = totalPages - 1;
            } else {
                pages[section] += direction;
            }

            // Boundary checks
            if (pages[section] < 0) pages[section] = 0;
            if (pages[section] >= totalPages) pages[section] = totalPages - 1;

            if (section === 'contacts') loadContacts();
            if (section === 'reservations') loadReservations();
            if (section === 'payments') loadPayments();
        }

        // MODALS
        function closeModal(modalName) {
            document.getElementById(`modal-${modalName}`).classList.add('hidden');
        }

        // CANCEL RESERVATION
        async function cancelReservation(creadoEn) {
            if (!confirm('Â¿EstÃ¡s seguro de cancelar esta reserva? Esta acciÃ³n actualizarÃ¡ el estado a "Cancelada".')) {
                return;
            }

            if (!db) return;

            try {
                // Update all reservations with the same creado_en timestamp
                const { error } = await db
                    .from('reservas')
                    .update({ estado: 'Cancelada' })
                    .eq('creado_en', creadoEn);

                if (error) {
                    alert('Error al cancelar: ' + error.message);
                } else {
                    alert('Reserva cancelada exitosamente');
                    loadReservations();
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        // TOURS FUNCTIONS
        async function loadTours() {
            if (!db) return;
            const tbody = document.getElementById('table-tours-body');
            if (!tbody) return;

            try {
                const { data: tours, error } = await db
                    .from('tours')
                    .select('*')
                    .order('activo', { ascending: false })
                    .order('nombre');

                if (error) throw error;

                if (!tours || tours.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-slate-500">No hay tours registrados</td></tr>';
                    return;
                }

                tbody.innerHTML = tours.map(t => {
                    const statusBadge = t.activo
                        ? '<span class="px-2 py-1 bg-emerald-100 text-emerald-700 text-xs rounded-full font-medium">Activo</span>'
                        : '<span class="px-2 py-1 bg-slate-100 text-slate-600 text-xs rounded-full font-medium">Inactivo</span>';

                    const toggleBtn = t.activo
                        ? `<button onclick='toggleTourStatus("${t.id}", true)' class="text-orange-600 hover:underline text-xs">Desactivar</button>`
                        : `<button onclick='toggleTourStatus("${t.id}", false)' class="text-emerald-600 hover:underline text-xs">Activar</button>`;

                    return `
                        <tr class="border-b hover:bg-slate-50 ${!t.activo ? 'opacity-60' : ''}">
                            <td class="px-6 py-4 font-medium">${t.nombre || '--'}</td>
                            <td class="px-6 py-4">${t.duracion || '--'}</td>
                            <td class="px-6 py-4 text-right">S/ ${t.precio ? parseFloat(t.precio).toFixed(2) : '0.00'}</td>
                            <td class="px-6 py-4">${statusBadge}</td>
                            <td class="px-6 py-4">
                                <button onclick='editTour(${JSON.stringify(t)})' class="text-emerald-600 hover:underline text-xs mr-3">Editar</button>
                                ${toggleBtn}
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (e) {
                console.error('Error loading tours:', e);
                tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-red-500">Error al cargar</td></tr>';
            }
        }

        function openTourModal() {
            document.getElementById('inp-t-id').value = '';
            document.getElementById('inp-t-name').value = '';
            document.getElementById('inp-t-desc').value = '';
            document.getElementById('inp-t-price').value = '';
            document.getElementById('inp-t-duration').value = '';
            document.getElementById('modal-tour').classList.remove('hidden');
        }

        function editTour(tour) {
            document.getElementById('inp-t-id').value = tour.id;
            document.getElementById('inp-t-name').value = tour.nombre || '';
            document.getElementById('inp-t-desc').value = tour.descripcion || '';
            document.getElementById('inp-t-price').value = tour.precio || '';
            document.getElementById('inp-t-duration').value = tour.duracion || '';
            document.getElementById('modal-tour').classList.remove('hidden');
        }

        async function saveTour() {
            const tourId = document.getElementById('inp-t-id').value;
            const nombre = document.getElementById('inp-t-name').value.trim();
            const descripcion = document.getElementById('inp-t-desc').value.trim();
            const precio = parseFloat(document.getElementById('inp-t-price').value);
            const duracion = document.getElementById('inp-t-duration').value.trim();

            if (!nombre) {
                alert('Debe ingresar un nombre para el tour');
                return;
            }

            if (!db) return;

            try {
                const payload = {
                    nombre: nombre,
                    descripcion: descripcion || null,
                    precio: precio || null,
                    duracion: duracion || null
                };

                let error;

                if (tourId) {
                    // UPDATE existing tour
                    ({ error } = await db.from('tours').update(payload).eq('id', tourId));
                } else {
                    // INSERT new tour
                    payload.id = crypto.randomUUID();
                    ({ error } = await db.from('tours').insert(payload));
                }

                if (error) {
                    alert('Error: ' + error.message);
                } else {
                    alert(tourId ? 'Tour actualizado exitosamente' : 'Tour creado exitosamente');
                    closeModal('tour');
                    // Reload tours list
                    loadTours();
                    // Reload available tours cache
                    loadToursCache();
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function toggleTourStatus(tourId, currentStatus) {
            const action = currentStatus ? 'desactivar' : 'activar';
            if (!confirm(`Â¿EstÃ¡s seguro de ${action} este tour?`)) {
                return;
            }

            if (!db) return;

            try {
                const { error } = await db
                    .from('tours')
                    .update({ activo: !currentStatus })
                    .eq('id', tourId);

                if (error) {
                    alert('Error: ' + error.message);
                } else {
                    alert(`Tour ${currentStatus ? 'desactivado' : 'activado'} exitosamente`);
                    // Reload tours list
                    loadTours();
                    // Reload cache (for reservation dropdowns)
                    loadToursCache();
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        // Sidebar Toggle Logic
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar-menu');
            const overlay = document.getElementById('sidebar-overlay');

            if (sidebar.classList.contains('-translate-x-full')) {
                // Open sidebar
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                // Close sidebar
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }
        }
    </script>
    <script>
        // EXPORT LOGIC - Updated with Filters and SheetJS
        function openExportModal(type) {
            document.getElementById('inp-export-type').value = type;
            document.getElementById('modal-export').classList.remove('hidden');

            // Set default dates (First day of current month to Today)
            const today = getPeruDate();
            const date = new Date();
            const firstDay = new Date(date.getFullYear(), date.getMonth(), 1);
            // Format first day manually
            const fdY = firstDay.getFullYear();
            const fdM = String(firstDay.getMonth() + 1).padStart(2, '0');
            const fdD = String(firstDay.getDate()).padStart(2, '0');

            document.getElementById('inp-export-from').value = `${fdY}-${fdM}-${fdD}`;
            document.getElementById('inp-export-to').value = today;

            // Toggle Status Field visibility
            const statusDiv = document.getElementById('div-export-status');
            if (type === 'payments') {
                statusDiv.classList.add('hidden');
            } else {
                statusDiv.classList.remove('hidden');
                // Adjust options if needed? For now keeps same set
            }
        }

        async function generateExport() {
            const type = document.getElementById('inp-export-type').value;
            const fromDate = document.getElementById('inp-export-from').value;
            const toDate = document.getElementById('inp-export-to').value;
            const status = document.getElementById('inp-export-status').value;

            if (!fromDate || !toDate) {
                alert('Seleccione un rango de fechas');
                return;
            }

            try {
                let data = [];
                let filename = `reporte_${type}_${fromDate}_${toDate}.xlsx`;

                if (type === 'contacts') {
                    let query = db.from('contactos').select('*');

                    if (status !== 'all') {
                        query = query.eq('estado', status);
                    }
                    query = query.gte('creado_en', fromDate).lte('creado_en', toDate + ' 23:59:59');

                    const { data: contacts, error } = await query;
                    if (error) throw error;
                    data = contacts.map(c => ({
                        'Nombre': c.nombre_completo,
                        'DNI': c.dni || '-',
                        'Whatsapp': c.whatsapp,
                        'Ciudad': c.ciudad,
                        'Fuente': c.fuente,
                        'Estado': c.estado,
                        'Registrado El': c.creado_en ? c.creado_en.split('T')[0] : '-'
                    }));
                }
                else if (type === 'reservations') {
                    // Fetch Reservations
                    let query = db.from('reservas').select('*')
                        .gte('creado_en', fromDate)
                        .lte('creado_en', toDate + ' 23:59:59');

                    if (status !== 'all') {
                        query = query.eq('estado', status);
                    }

                    const { data: rawRes, error } = await query;
                    if (error) throw error;

                    if (rawRes.length === 0) {
                        alert('No se encontraron reservas con esos filtros.');
                        return;
                    }

                    // Fetch Related Data
                    const contactIds = [...new Set(rawRes.map(r => r.contacto_id))];
                    const tourIds = [...new Set(rawRes.map(r => r.tour_id))];
                    const reservaIds = rawRes.map(r => r.id);

                    const { data: contacts } = await db.from('contactos').select('id, nombre_completo, dni').in('id', contactIds);
                    const { data: tours } = await db.from('tours').select('id, nombre').in('id', tourIds);
                    const { data: payments } = await db.from('pagos').select('reserva_id, monto').in('reserva_id', reservaIds);


                    const cMap = {}; contacts?.forEach(c => cMap[c.id] = c);
                    const tMap = {}; tours?.forEach(t => tMap[t.id] = t.nombre);
                    const pMap = {}; payments?.forEach(p => {
                        pMap[p.reserva_id] = (pMap[p.reserva_id] || 0) + parseFloat(p.monto);
                    });

                    // CONSOLIDATION LOGIC
                    const grouped = {};
                    rawRes.forEach(r => {
                        // Group by package (creado_en)
                        // Use exact timestamp string to group identical packages
                        const key = r.creado_en;

                        if (!grouped[key]) {
                            grouped[key] = {
                                fecha: r.fecha_reserva ? r.fecha_reserva.split('T')[0] : '-',
                                created_at: key, // Store key for access in map
                                contacto_id: r.contacto_id,
                                tour_names: [],
                                pax: r.PAX,
                                duracion: r.duracion,
                                monto_total: 0,
                                pagado: 0,
                                estado: r.estado,
                                ids: []
                            };
                        }

                        // Add tour name if valid
                        const tName = tMap[r.tour_id];
                        if (tName) grouped[key].tour_names.push(tName);

                        // Handle Duplicate Amounts:
                        // Since 'monto_total' is stored fully in each row of the same package (e.g. 300, 300),
                        // we only take it ONCE for the group.
                        if (grouped[key].ids.length === 0) {
                            grouped[key].monto_total = parseFloat(r.monto_total || 0);
                        }

                        // Sum payments:
                        // Payments are usually linked to ONE of the reservation IDs in the group.
                        // So checking all IDs and summing unique payments works.
                        grouped[key].pagado += (pMap[r.id] || 0);

                        grouped[key].ids.push(r.id);
                    });

                    // Build Final List
                    data = Object.values(grouped).map(g => {
                        const client = cMap[g.contacto_id] || {};
                        // Consolidate identical statuses or show list? 
                        // Usually package is all same status.

                        return {
                            'Fecha Registro': g.created_at ? g.created_at.split('T')[0] : '-',
                            'Fecha Inicio Tour': g.fecha,
                            'Cliente': client.nombre_completo || 'Desconocido',
                            'DNI': client.dni || '-',
                            'Paquete / Tours': g.tour_names.join(' + '),
                            'PAX': g.pax,
                            'DuraciÃ³n (DÃ­as)': g.duracion,
                            'Monto Total': g.monto_total,
                            'Pagado': g.pagado,
                            'Saldo': g.monto_total - g.pagado,
                            'Estado': g.estado
                        };
                    });
                }
                else if (type === 'payments') {
                    const { data: payments, error } = await db.from('pagos')
                        .select('*, reservas(contacto_id, tour_id, creado_en)') // Fetch tour_id and creado_en
                        .gte('fecha_pago', fromDate + ' 00:00:00')
                        .lte('fecha_pago', toDate + ' 23:59:59')
                        .order('fecha_pago', { ascending: false });

                    if (error) throw error;

                    // Need client names and package tour names
                    const resIds = payments.map(p => p.reserva_id);
                    const { data: resData } = await db.from('reservas').select('id, contacto_id, tour_id, creado_en').in('id', resIds);

                    if (resData) {
                        const timestamps = [...new Set(resData.map(r => r.creado_en).filter(Boolean))];

                        // Fetch all sibling reservations for packages
                        const { data: siblingReservas } = await db.from('reservas')
                            .select('id, tour_id, creado_en')
                            .in('creado_en', timestamps);

                        const cIds = [...new Set(resData.map(r => r.contacto_id))];
                        const allTourIds = [...new Set(siblingReservas?.map(r => r.tour_id).filter(Boolean) || [])];

                        const { data: contacts } = await db.from('contactos').select('id, nombre_completo').in('id', cIds);
                        const { data: tours } = await db.from('tours').select('id, nombre').in('id', allTourIds);

                        const rToC = {};
                        resData.forEach(r => rToC[r.id] = r.contacto_id);

                        const tourMap = {};
                        tours?.forEach(t => tourMap[t.id] = t.nombre);

                        // Map packages
                        const packageTours = {};
                        siblingReservas?.forEach(r => {
                            if (!packageTours[r.creado_en]) packageTours[r.creado_en] = [];
                            if (r.tour_id && tourMap[r.tour_id]) {
                                packageTours[r.creado_en].push(tourMap[r.tour_id]);
                            }
                        });

                        const rToCreatedEn = {};
                        resData.forEach(r => rToCreatedEn[r.id] = r.creado_en);

                        const cToN = {}; contacts?.forEach(c => cToN[c.id] = c.nombre_completo);

                        payments.forEach(p => {
                            p.client_name = cToN[rToC[p.reserva_id]] || 'Desconocido';

                            const pkgKey = rToCreatedEn[p.reserva_id];
                            p.tour_name = packageTours[pkgKey] ? [...new Set(packageTours[pkgKey])].join(' + ') : '-';
                        });
                    }

                    data = payments.map(p => ({
                        'Fecha': p.fecha_pago ? p.fecha_pago.split('T')[0] : '-',
                        'Cliente': p.client_name || '-',
                        'Tour': p.tour_name || '-',
                        'Monto': p.monto,
                        'Metodo': p.metodo_pago,
                        'ID Recibo': p.id
                    }));
                }

                if (data.length === 0) {
                    alert('No se encontraron datos con esos filtros.');
                    return;
                }

                // Generate Excel
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Reporte");
                XLSX.writeFile(wb, filename);

                closeModal('export');

            } catch (e) {
                console.error(e);
                alert('Error al exportar: ' + e.message);
            }
        }
    </script>
    <script>
        // STEALTH LINK LOGIC
        window.addEventListener('load', async () => {
            const params = new URLSearchParams(window.location.search);
            const telefono = params.get('telefono');

            if (telefono) {
                console.log("Stealth Link detected:", telefono);

                // Wait a moment for app initialization
                setTimeout(async () => {
                    if (!db) return;

                    // Normalize phone (Try multiple formats to ensure match)
                    const cleanPhone = telefono.replace(/\D/g, ''); // Remove non-digits
                    const phoneWithCountry = cleanPhone.startsWith('51') ? '+' + cleanPhone : '+51' + cleanPhone; // +519...
                    const phoneRaw = cleanPhone; // 9... (or 519...)

                    console.log("Searching contact variants:", phoneWithCountry, phoneRaw);

                    const { data, error } = await db
                        .from('contactos')
                        .select('id')
                        .or(`whatsapp.eq.${phoneWithCountry},whatsapp.eq.${phoneRaw},whatsapp.eq.+${phoneRaw}`)
                        .maybeSingle();

                    if (data && data.id) {
                        try {
                            await openReservationModal();
                            const select = document.getElementById('inp-r-cliente');
                            if (select) {
                                select.value = data.id;
                                select.dispatchEvent(new Event('change')); // Trigger auto-fill
                            }
                        } catch (e) {
                            console.error("Error opening modal via stealth link:", e);
                        }
                    } else {
                        console.warn("Contact not found:", phoneSearch);
                        // Optional: Open Create Contact modal with phone pre-filled
                        openContactModal();
                        document.getElementById('inp-c-phone').value = phoneSearch;
                    }
                }, 1000); // 1s delay to ensure DB init
            }
        });
    </script>
</body>

</html>